<!--
  SimpleSalesman Excel Export GUI
  
  Professional OAuth2/PKCE-based authentication interface for Excel Export API
  Following the same pattern as the SimpleSalesman Joke API GUI

  Features:
  - OAuth2 Authorization Code Flow with PKCE
  - Redirect-based Keycloak authentication
  - Token management and expiry handling
  - User information display
  - Multiple export options (Projects, Notes, Combined, Regional)
  - Progress tracking and file download handling
  - Export statistics and history
  - Configurable endpoints

  @author Yaroslav Volokhodko
  @version exam
  @since 0.0.9
  @requires Bearer token authentication
  @requires Modern browser with JavaScript enabled
-->
<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SimpleSalesman - Excel Export GUI</title>

    <style>
        :root {
            --keycloak-primary: #0066cc;
            --keycloak-primary-hover: #004499;
            --keycloak-primary-light: #1a4a7a;
            --keycloak-secondary: #2a2a2a;
            --keycloak-background: #1e1e1e;
            --keycloak-sidebar: #161616;
            --keycloak-content: #262626;
            --keycloak-white: #ffffff;
            --keycloak-text: #f0f0f0;
            --keycloak-text-secondary: #a0a0a0;
            --keycloak-text-muted: #6f6f6f;
            --keycloak-border: #404040;
            --keycloak-border-light: #333333;
            --keycloak-success: #24a148;
            --keycloak-error: #da1e28;
            --keycloak-warning: #f1c21b;
            --keycloak-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            --keycloak-shadow-hover: 0 4px 16px rgba(0, 0, 0, 0.4);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--keycloak-background);
            min-height: 100vh;
            padding: 20px;
            color: var(--keycloak-text);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--keycloak-content);
            border-radius: 15px;
            box-shadow: var(--keycloak-shadow-hover);
            overflow: hidden;
            border: 1px solid var(--keycloak-border);
        }

        .header {
            background: var(--keycloak-primary);
            padding: 30px;
            text-align: center;
            color: var(--keycloak-white);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .config-section {
            background: var(--keycloak-secondary);
            padding: 20px;
            border-bottom: 2px solid var(--keycloak-border);
        }

        .config-form {
            background: var(--keycloak-content);
            border: 1px solid var(--keycloak-border);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .config-form h4 {
            color: var(--keycloak-primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--keycloak-text);
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--keycloak-border);
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
            background: var(--keycloak-secondary);
            color: var(--keycloak-text);
            font-family: inherit;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--keycloak-primary);
        }

        .auth-section {
            text-align: center;
            padding: 20px;
        }

        .status-indicator {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
            margin-bottom: 15px;
            display: inline-block;
        }

        .status-connected {
            background: var(--keycloak-success);
            color: var(--keycloak-white);
        }

        .status-disconnected {
            background: var(--keycloak-error);
            color: var(--keycloak-white);
        }

        .btn {
            background: var(--keycloak-primary);
            color: var(--keycloak-white);
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 5px;
            text-decoration: none;
            display: inline-block;
            position: relative;
        }

        .btn:hover:not(:disabled) {
            background: var(--keycloak-primary-hover);
            transform: translateY(-2px);
            box-shadow: var(--keycloak-shadow-hover);
        }

        .btn:disabled {
            background: var(--keycloak-text-muted);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-success {
            background: var(--keycloak-success);
        }

        .btn-success:hover:not(:disabled) {
            background: #1e7e34;
        }

        .btn-danger {
            background: var(--keycloak-error);
        }

        .btn-danger:hover:not(:disabled) {
            background: #c82333;
        }

        .btn-warning {
            background: var(--keycloak-warning);
            color: var(--keycloak-background);
        }

        .btn-warning:hover:not(:disabled) {
            background: #d39e00;
        }

        .btn-large {
            padding: 16px 32px;
            font-size: 16px;
            border-radius: 12px;
        }

        .user-info {
            background: var(--keycloak-content);
            padding: 15px;
            border-radius: 8px;
            margin: 15px auto;
            border-left: 4px solid var(--keycloak-primary);
            display: none;
            max-width: 500px;
        }

        .user-info h4 {
            color: var(--keycloak-primary);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .user-info-content {
            display: grid;
            gap: 8px;
        }

        .user-info-content div {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px solid var(--keycloak-border-light);
        }

        .export-section {
            padding: 30px;
        }

        .export-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .export-card {
            background: var(--keycloak-secondary);
            border-radius: 12px;
            padding: 25px;
            border: 1px solid var(--keycloak-border);
            transition: all 0.3s ease;
            position: relative;
        }

        .export-card:hover {
            box-shadow: var(--keycloak-shadow);
            transform: translateY(-2px);
        }

        .export-card h4 {
            color: var(--keycloak-primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2rem;
        }

        .export-card p {
            color: var(--keycloak-text-secondary);
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .export-card .form-group {
            margin-bottom: 15px;
        }

        .export-card .form-group input {
            background: var(--keycloak-content);
        }

        .progress-container {
            background: var(--keycloak-background);
            border-radius: 8px;
            overflow: hidden;
            height: 8px;
            margin: 10px 0;
            border: 1px solid var(--keycloak-border);
            display: none;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--keycloak-primary), var(--keycloak-success));
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 0.85rem;
            color: var(--keycloak-text-secondary);
            text-align: center;
            margin-top: 5px;
        }

        .export-stats {
            background: var(--keycloak-content);
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid var(--keycloak-border);
        }

        .export-stats h4 {
            color: var(--keycloak-primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: var(--keycloak-secondary);
            border-radius: 8px;
            border: 1px solid var(--keycloak-border-light);
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--keycloak-primary);
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--keycloak-text-secondary);
            margin-top: 5px;
        }

        .export-history {
            background: var(--keycloak-content);
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid var(--keycloak-border);
        }

        .export-history h4 {
            color: var(--keycloak-primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .history-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .history-item {
            padding: 10px;
            border-bottom: 1px solid var(--keycloak-border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-info {
            flex: 1;
        }

        .history-filename {
            font-weight: 600;
            color: var(--keycloak-text);
        }

        .history-details {
            font-size: 0.85rem;
            color: var(--keycloak-text-secondary);
            margin-top: 2px;
        }

        .api-test {
            background: var(--keycloak-content);
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            border: 1px solid var(--keycloak-border);
        }

        .api-test h4 {
            color: var(--keycloak-primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .response-area {
            margin-top: 15px;
            padding: 15px;
            background: var(--keycloak-secondary);
            border-radius: 8px;
            border-left: 4px solid var(--keycloak-primary);
            display: none;
        }

        .response-content {
            background: var(--keycloak-background);
            color: var(--keycloak-text);
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            border: 1px solid var(--keycloak-border);
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: var(--keycloak-white);
            font-weight: 600;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            max-width: 350px;
            box-shadow: var(--keycloak-shadow-hover);
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            background: var(--keycloak-success);
        }

        .toast.error {
            background: var(--keycloak-error);
        }

        .toast.warning {
            background: var(--keycloak-warning);
            color: var(--keycloak-background);
        }

        .spinner {
            border: 2px solid var(--keycloak-border);
            border-top: 2px solid var(--keycloak-primary);
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 8px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .export-grid {
                grid-template-columns: 1fr;
            }
            
            .btn {
                width: 100%;
                max-width: 300px;
            }
            
            .config-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä SimpleSalesman Excel Export</h1>
            <p class="subtitle">OAuth2 Authentication Flow</p>
        </div>

        <div class="config-section">
            <div class="config-form">
                <h4>üîß Configuration Settings</h4>
                <div class="config-grid">
                    <div class="form-group">
                        <label>API Host</label>
                        <input type="text" id="apiHost" value="http://localhost:8081" placeholder="API Host URL">
                    </div>
                    <div class="form-group">
                        <label>Keycloak Base URL</label>
                        <input type="text" id="keycloakBaseUrl" value="http://localhost:8080" placeholder="Keycloak URL">
                    </div>
                    <div class="form-group">
                        <label>Realm</label>
                        <input type="text" id="realm" value="simple-salesman-backend" placeholder="Keycloak Realm">
                    </div>
                    <div class="form-group">
                        <label>Client ID</label>
                        <input type="text" id="clientId" value="simple-salesman-backend" placeholder="OAuth Client ID">
                    </div>
                </div>
                <button class="btn" onclick="updateConfiguration()">üìù Update Configuration</button>
            </div>

            <div class="auth-section">
                <div class="status-indicator status-disconnected" id="authStatus">üîí Not Authenticated</div>
                <button class="btn btn-success" onclick="loginWithKeycloak()" id="loginBtn">üîê Login with Keycloak</button>
                <button class="btn btn-danger" onclick="logout()" id="logoutBtn" style="display: none;">üö™ Logout</button>
                
                <div class="user-info" id="userInfo">
                    <h4>üë§ User Information</h4>
                    <div class="user-info-content" id="userInfoContent"></div>
                </div>
            </div>
        </div>

                    <div class="export-section">
                <div style="text-align: center; margin-bottom: 20px;">
                    <button class="btn btn-warning" onclick="testEndpointsAvailability()" disabled id="quickTestBtn">
                        üß™ Quick Endpoint Test
                    </button>
                    <p style="font-size: 0.9rem; color: var(--keycloak-text-secondary); margin-top: 8px;">
                        Test this first if exports are failing
                    </p>
                </div>
            <div class="export-grid">
                <!-- Combined Projects and Notes Export -->
                <div class="export-card">
                    <h4>üìä Combined Export</h4>
                    <p>Export all projects and notes in a multi-sheet Excel file. Projects and notes are organized in separate tabs with full relationship mapping.</p>
                    <button class="btn btn-large btn-success" onclick="exportCombined()" disabled id="exportCombinedBtn">
                        üìä Export Projects + Notes
                    </button>
                    <div class="progress-container" id="progressCombined">
                        <div class="progress-bar" id="progressBarCombined"></div>
                    </div>
                    <div class="progress-text" id="progressTextCombined"></div>
                </div>

                <!-- Regional Export -->
                <div class="export-card">
                    <h4>üåç Regional Export</h4>
                    <p>Export projects and notes filtered by region. Includes all address-linked notes for projects in the specified region.</p>
                    <div class="form-group">
                        <label>Region ID</label>
                        <input type="number" id="regionId" value="1" placeholder="Enter region ID" min="1">
                    </div>
                    <button class="btn btn-large" onclick="exportByRegion()" disabled id="exportRegionBtn">
                        üåç Export by Region
                    </button>
                    <div class="progress-container" id="progressRegion">
                        <div class="progress-bar" id="progressBarRegion"></div>
                    </div>
                    <div class="progress-text" id="progressTextRegion"></div>
                </div>

                <!-- Projects Only Export -->
                <div class="export-card">
                    <h4>üèóÔ∏è Projects Only</h4>
                    <p>Export only project data in the traditional single-sheet format. Legacy compatibility for existing integrations.</p>
                    <button class="btn btn-large btn-warning" onclick="exportProjectsOnly()" disabled id="exportProjectsBtn">
                        üèóÔ∏è Export Projects Only
                    </button>
                    <div class="progress-container" id="progressProjects">
                        <div class="progress-bar" id="progressBarProjects"></div>
                    </div>
                    <div class="progress-text" id="progressTextProjects"></div>
                </div>

                <!-- Notes Only Export -->
                <div class="export-card">
                    <h4>üìù Notes Only</h4>
                    <p>Export only notes data with address and project associations. Useful for note analysis and customer feedback review.</p>
                    <button class="btn btn-large" onclick="exportNotesOnly()" disabled id="exportNotesBtn">
                        üìù Export Notes Only
                    </button>
                    <div class="progress-container" id="progressNotes">
                        <div class="progress-bar" id="progressBarNotes"></div>
                    </div>
                    <div class="progress-text" id="progressTextNotes"></div>
                </div>
            </div>

            <div class="export-stats">
                <h4>üìà Export Statistics</h4>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="statTotalExports">0</div>
                        <div class="stat-label">Total Exports</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="statAvgSize">0 KB</div>
                        <div class="stat-label">Avg File Size</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="statAvgTime">0ms</div>
                        <div class="stat-label">Avg Export Time</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="statLastExport">-</div>
                        <div class="stat-label">Last Export</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="statTokenExpiry">-</div>
                        <div class="stat-label">Token Expires</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="statSessionTime">0m</div>
                        <div class="stat-label">Session Time</div>
                    </div>
                </div>
            </div>

            <div class="export-history">
                <h4>üìã Export History</h4>
                <div class="history-list" id="historyList">
                    <div style="text-align: center; color: var(--keycloak-text-secondary); padding: 20px;">
                        No exports in this session yet
                    </div>
                </div>
            </div>

            <div class="api-test">
                <h4>üß™ API Testing</h4>
                <button class="btn" onclick="testApiHealth()" disabled id="healthBtn">
                    üè• Health Check
                </button>
                <button class="btn" onclick="testEndpointsAvailability()" disabled id="endpointsBtn">
                    üîó Test Endpoints
                </button>
                <button class="btn" onclick="showTokenInfo()" disabled id="tokenInfoBtn">
                    üé´ Show Token Info
                </button>
                
                <div class="response-area" id="testResponse">
                    <h4>Test Response:</h4>
                    <div class="response-content" id="testResponseContent"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration object - editable via UI
        let OAUTH_CONFIG = {
            apiHost: 'http://localhost:8081',
            keycloakBaseUrl: 'http://localhost:8080',
            realm: 'simple-salesman-backend',
            clientId: 'simple-salesman-backend',
            redirectUri: window.location.origin + window.location.pathname
        };

        // Runtime state
        let accessToken = '';
        let refreshToken = '';
        let userInfo = {};
        let sessionStats = {
            totalExports: 0,
            fileSizes: [],
            exportTimes: [],
            sessionStart: Date.now(),
            exportHistory: []
        };

        // Update configuration from form inputs
        function updateConfiguration() {
            OAUTH_CONFIG.apiHost = document.getElementById('apiHost').value;
            OAUTH_CONFIG.keycloakBaseUrl = document.getElementById('keycloakBaseUrl').value;
            OAUTH_CONFIG.realm = document.getElementById('realm').value;
            OAUTH_CONFIG.clientId = document.getElementById('clientId').value;
            
            // Save to localStorage for persistence
            localStorage.setItem('export_oauth_config', JSON.stringify(OAUTH_CONFIG));
            
            showToast('Configuration updated successfully!', 'success');
        }

        // Load configuration from localStorage if available
        function loadConfiguration() {
            const savedConfig = localStorage.getItem('export_oauth_config');
            if (savedConfig) {
                OAUTH_CONFIG = JSON.parse(savedConfig);
                document.getElementById('apiHost').value = OAUTH_CONFIG.apiHost;
                document.getElementById('keycloakBaseUrl').value = OAUTH_CONFIG.keycloakBaseUrl;
                document.getElementById('realm').value = OAUTH_CONFIG.realm;
                document.getElementById('clientId').value = OAUTH_CONFIG.clientId;
            }
        }

        // PKCE helper functions
        function generateCodeVerifier() {
            const array = new Uint8Array(32);
            crypto.getRandomValues(array);
            return btoa(String.fromCharCode.apply(null, array))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=/g, '');
        }

        async function generateCodeChallenge(verifier) {
            const encoder = new TextEncoder();
            const data = encoder.encode(verifier);
            const digest = await crypto.subtle.digest('SHA-256', data);
            return btoa(String.fromCharCode.apply(null, new Uint8Array(digest)))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=/g, '');
        }

        // OAuth2 login flow
        async function loginWithKeycloak() {
            const codeVerifier = generateCodeVerifier();
            const codeChallenge = await generateCodeChallenge(codeVerifier);
            const state = generateCodeVerifier();

            sessionStorage.setItem('code_verifier', codeVerifier);
            sessionStorage.setItem('oauth_state', state);

            const keycloakAuthUrl = `${OAUTH_CONFIG.keycloakBaseUrl}/realms/${OAUTH_CONFIG.realm}/protocol/openid-connect/auth`;
            
            const params = new URLSearchParams({
                response_type: 'code',
                client_id: OAUTH_CONFIG.clientId,
                redirect_uri: OAUTH_CONFIG.redirectUri,
                scope: 'openid profile email',
                state: state,
                code_challenge: codeChallenge,
                code_challenge_method: 'S256'
            });

            const authUrl = `${keycloakAuthUrl}?${params.toString()}`;
            window.location.href = authUrl;
        }

        // Handle OAuth callback
        async function handleOAuthCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const state = urlParams.get('state');
            const error = urlParams.get('error');

            if (error) {
                console.error('OAuth Error:', error, urlParams.get('error_description'));
                showToast(`OAuth Error: ${error}`, 'error');
                return;
            }

            if (!code || !state) {
                return;
            }

            const storedState = sessionStorage.getItem('oauth_state');
            if (state !== storedState) {
                console.error('OAuth state mismatch');
                showToast('Invalid OAuth state. Possible CSRF attack.', 'error');
                return;
            }

            const codeVerifier = sessionStorage.getItem('code_verifier');
            if (!codeVerifier) {
                console.error('Missing code verifier');
                showToast('Missing code verifier. Please try logging in again.', 'error');
                return;
            }

            try {
                const keycloakTokenUrl = `${OAUTH_CONFIG.keycloakBaseUrl}/realms/${OAUTH_CONFIG.realm}/protocol/openid-connect/token`;
                
                const tokenResponse = await fetch(keycloakTokenUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams({
                        grant_type: 'authorization_code',
                        client_id: OAUTH_CONFIG.clientId,
                        code: code,
                        redirect_uri: OAUTH_CONFIG.redirectUri,
                        code_verifier: codeVerifier
                    })
                });

                if (!tokenResponse.ok) {
                    throw new Error(`Token exchange failed: ${tokenResponse.status}`);
                }

                const tokens = await tokenResponse.json();
                accessToken = tokens.access_token;
                refreshToken = tokens.refresh_token;

                const payload = JSON.parse(atob(accessToken.split('.')[1]));
                userInfo = {
                    username: payload.preferred_username || payload.sub,
                    email: payload.email,
                    name: payload.name,
                    roles: payload.realm_access?.roles || [],
                    exp: payload.exp
                };

                sessionStorage.removeItem('code_verifier');
                sessionStorage.removeItem('oauth_state');
                window.history.replaceState({}, document.title, window.location.pathname);

                updateAuthStatus(true);
                displayUserInfo();
                updateStats();

                showToast('üéâ Successfully authenticated!', 'success');
                console.log('‚úÖ OAuth login successful');

            } catch (error) {
                console.error('Token exchange error:', error);
                showToast(`Authentication failed: ${error.message}`, 'error');
            }
        }

        function logout() {
            accessToken = '';
            refreshToken = '';
            userInfo = {};
            sessionStats = {
                totalExports: 0,
                fileSizes: [],
                exportTimes: [],
                sessionStart: Date.now(),
                exportHistory: []
            };
            updateAuthStatus(false);
            updateStats();
            updateHistory();
            sessionStorage.clear();
            showToast('Logged out successfully', 'warning');
        }

        function updateAuthStatus(isAuthenticated) {
            const statusElement = document.getElementById('authStatus');
            const loginBtn = document.getElementById('loginBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const userInfoDiv = document.getElementById('userInfo');
            
            const exportBtns = ['exportCombinedBtn', 'exportRegionBtn', 'exportProjectsBtn', 'exportNotesBtn'];
            const testBtns = ['healthBtn', 'endpointsBtn', 'tokenInfoBtn', 'quickTestBtn'];

            if (isAuthenticated) {
                statusElement.textContent = 'üîì Authenticated';
                statusElement.className = 'status-indicator status-connected';
                loginBtn.style.display = 'none';
                logoutBtn.style.display = 'inline-block';
                userInfoDiv.style.display = 'block';
                
                exportBtns.forEach(btnId => {
                    document.getElementById(btnId).disabled = false;
                });
                testBtns.forEach(btnId => {
                    document.getElementById(btnId).disabled = false;
                });
            } else {
                statusElement.textContent = 'üîí Not Authenticated';
                statusElement.className = 'status-indicator status-disconnected';
                loginBtn.style.display = 'inline-block';
                logoutBtn.style.display = 'none';
                userInfoDiv.style.display = 'none';
                
                exportBtns.forEach(btnId => {
                    document.getElementById(btnId).disabled = true;
                });
                testBtns.forEach(btnId => {
                    document.getElementById(btnId).disabled = true;
                });
            }
        }

        function displayUserInfo() {
            const userInfoContent = document.getElementById('userInfoContent');
            userInfoContent.innerHTML = `
                <div><strong>Username:</strong> <span>${userInfo.username || 'N/A'}</span></div>
                <div><strong>Email:</strong> <span>${userInfo.email || 'N/A'}</span></div>
                <div><strong>Name:</strong> <span>${userInfo.name || 'N/A'}</span></div>
                <div><strong>Roles:</strong> <span>${userInfo.roles?.join(', ') || 'None'}</span></div>
                <div><strong>Token Expires:</strong> <span>${new Date(userInfo.exp * 1000).toLocaleString()}</span></div>
            `;
        }

        function updateStats() {
            document.getElementById('statTotalExports').textContent = sessionStats.totalExports;
            
            if (sessionStats.fileSizes.length > 0) {
                const avgSize = Math.round(sessionStats.fileSizes.reduce((a, b) => a + b, 0) / sessionStats.fileSizes.length / 1024);
                document.getElementById('statAvgSize').textContent = avgSize + ' KB';
            }
            
            if (sessionStats.exportTimes.length > 0) {
                const avgTime = Math.round(sessionStats.exportTimes.reduce((a, b) => a + b, 0) / sessionStats.exportTimes.length);
                document.getElementById('statAvgTime').textContent = avgTime + 'ms';
            }
            
            if (sessionStats.totalExports > 0) {
                document.getElementById('statLastExport').textContent = new Date().toLocaleTimeString();
            }
            
            if (userInfo.exp) {
                const expiry = new Date(userInfo.exp * 1000);
                const now = new Date();
                const minutesLeft = Math.floor((expiry - now) / (1000 * 60));
                document.getElementById('statTokenExpiry').textContent = minutesLeft > 0 ? `${minutesLeft}min` : 'Expired';
            }

            const sessionMinutes = Math.floor((Date.now() - sessionStats.sessionStart) / (1000 * 60));
            document.getElementById('statSessionTime').textContent = sessionMinutes + 'm';
        }

        function updateHistory() {
            const historyList = document.getElementById('historyList');
            
            if (sessionStats.exportHistory.length === 0) {
                historyList.innerHTML = `
                    <div style="text-align: center; color: var(--keycloak-text-secondary); padding: 20px;">
                        No exports in this session yet
                    </div>
                `;
                return;
            }

            historyList.innerHTML = sessionStats.exportHistory.map(item => `
                <div class="history-item">
                    <div class="history-info">
                        <div class="history-filename">${item.filename}</div>
                        <div class="history-details">${item.type} ‚Ä¢ ${(item.size / 1024).toFixed(1)} KB ‚Ä¢ ${item.time}ms</div>
                    </div>
                    <div style="color: var(--keycloak-success);">‚úì</div>
                </div>
            `).join('');
        }

        // Export functions
        async function exportCombined() {
            await performExport('/api/v1/export/excel', 'Combined', 'progressCombined');
        }

        async function exportByRegion() {
            const regionId = document.getElementById('regionId').value;
            if (!regionId) {
                showToast('Please enter a region ID', 'error');
                return;
            }
            await performExport(`/api/v1/export/excel/region/${regionId}`, `Region_${regionId}`, 'progressRegion');
        }

        async function exportProjectsOnly() {
            await performExport('/api/v1/export/excel/projects-only', 'Projects_Only', 'progressProjects');
        }

        async function exportNotesOnly() {
            await performExport('/api/v1/export/excel/notes-only', 'Notes_Only', 'progressNotes');
        }

        async function performExport(endpoint, type, progressId) {
            if (!isTokenValid()) {
                showToast('Token expired. Please login again.', 'error');
                logout();
                return;
            }

            const progressContainer = document.getElementById(progressId);
            const progressBar = document.getElementById(progressId.replace('progress', 'progressBar'));
            const progressText = document.getElementById(progressId.replace('progress', 'progressText'));
            
            // Show progress
            progressContainer.style.display = 'block';
            progressBar.style.width = '10%';
            progressText.textContent = 'Starting export...';

            const startTime = Date.now();
            const fullUrl = `${OAUTH_CONFIG.apiHost}${endpoint}`;

            try {
                progressBar.style.width = '30%';
                progressText.textContent = 'Requesting export...';

                console.log('üì° Making export request to:', fullUrl);
                console.log('üîë Using token:', accessToken.substring(0, 20) + '...');

                const response = await fetch(fullUrl, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Accept': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
                    }
                });

                console.log('üìä Response status:', response.status);
                console.log('üìã Response headers:', Object.fromEntries(response.headers.entries()));

                progressBar.style.width = '70%';
                progressText.textContent = 'Processing response...';

                if (!response.ok) {
                    // Try to get error details from response body
                    let errorDetails = '';
                    try {
                        const errorText = await response.text();
                        console.error('‚ùå Error response body:', errorText);
                        errorDetails = errorText ? ` - ${errorText}` : '';
                    } catch (e) {
                        console.error('‚ùå Could not read error response body:', e);
                    }

                    if (response.status === 401) {
                        throw new Error('Authentication failed. Please login again.');
                    } else if (response.status === 404) {
                        throw new Error(`Export endpoint not found. Check if ${endpoint} exists on your server.`);
                    } else if (response.status === 500) {
                        throw new Error(`Server error (500): There might be an issue with your export service or database${errorDetails}`);
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}${errorDetails}`);
                    }
                }

                // Check if we actually got an Excel file
                const contentType = response.headers.get('Content-Type');
                if (!contentType || !contentType.includes('spreadsheetml')) {
                    console.warn('‚ö†Ô∏è Unexpected content type:', contentType);
                    // Still try to process as Excel file
                }

                const blob = await response.blob();
                const exportTime = Date.now() - startTime;

                console.log('‚úÖ Export successful, file size:', blob.size, 'bytes');

                progressBar.style.width = '90%';
                progressText.textContent = 'Preparing download...';

                // Extract filename from Content-Disposition header
                const disposition = response.headers.get('Content-Disposition');
                let filename = `SimpleSalesman_${type}_Export.xlsx`;
                if (disposition && disposition.indexOf('filename=') !== -1) {
                    filename = disposition.split('filename=')[1].replace(/"/g, '');
                }

                // Download file
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                progressBar.style.width = '100%';
                progressText.textContent = 'Download complete!';

                // Update statistics
                sessionStats.totalExports++;
                sessionStats.fileSizes.push(blob.size);
                sessionStats.exportTimes.push(exportTime);
                sessionStats.exportHistory.unshift({
                    filename,
                    type,
                    size: blob.size,
                    time: exportTime,
                    timestamp: new Date().toLocaleTimeString()
                });

                // Keep only last 10 exports in history
                if (sessionStats.exportHistory.length > 10) {
                    sessionStats.exportHistory = sessionStats.exportHistory.slice(0, 10);
                }

                updateStats();
                updateHistory();

                showToast(`‚úÖ ${type} export completed!`, 'success');

                // Hide progress after delay
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                }, 2000);

            } catch (error) {
                console.error('‚ùå Export error:', error);
                console.error('üîó Failed URL:', fullUrl);

                if (error.message.includes('Authentication')) {
                    logout();
                    return;
                }

                progressBar.style.width = '0%';
                progressText.textContent = 'Export failed';
                showToast(`Export failed: ${error.message}`, 'error');

                // Show detailed error in test response area for debugging
                showTestResponse({
                    error: error.message,
                    endpoint: endpoint,
                    fullUrl: fullUrl,
                    timestamp: new Date().toISOString(),
                    troubleshooting: [
                        "1. Check if your export endpoints are running",
                        "2. Verify the package 'exam.EXP' is correctly configured",
                        "3. Check server logs for detailed error information",
                        "4. Test endpoints manually with Postman or curl",
                        "5. Ensure your database has projects and/or notes data"
                    ]
                });

                setTimeout(() => {
                    progressContainer.style.display = 'none';
                }, 3000);
            }
        }

        // Testing functions
        async function testApiHealth() {
            if (!isTokenValid()) {
                showToast('Token expired. Please login again.', 'error');
                logout();
                return;
            }

            try {
                // Test general API health first
                const healthResponse = await fetch(`${OAUTH_CONFIG.apiHost}/actuator/health`, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                let healthResult = null;
                if (healthResponse.ok) {
                    healthResult = await healthResponse.json();
                }

                // Test a simple export endpoint to see if export functionality is working
                const exportTestResponse = await fetch(`${OAUTH_CONFIG.apiHost}/api/v1/export/excel/projects-only`, {
                    method: 'HEAD',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                const overallHealth = {
                    generalHealth: {
                        status: healthResponse.status,
                        data: healthResult,
                        ok: healthResponse.ok
                    },
                    exportEndpoint: {
                        status: exportTestResponse.status,
                        statusText: exportTestResponse.statusText,
                        ok: exportTestResponse.ok
                    },
                    timestamp: new Date().toISOString()
                };

                if (healthResponse.ok && exportTestResponse.ok) {
                    showToast('‚úÖ API Health Check: All OK', 'success');
                } else if (healthResponse.ok) {
                    showToast('‚ö†Ô∏è API is healthy but export endpoints may have issues', 'warning');
                } else {
                    showToast('‚ùå API Health Check: Issues detected', 'error');
                }
                
                showTestResponse(overallHealth);

            } catch (error) {
                showToast(`‚ùå Health Check Failed: ${error.message}`, 'error');
                showTestResponse({
                    error: error.message,
                    suggestions: [
                        "1. Check if your Spring Boot application is running on " + OAUTH_CONFIG.apiHost,
                        "2. Verify that actuator endpoints are enabled",
                        "3. Check if export endpoints are properly configured",
                        "4. Ensure CORS is configured for your frontend domain"
                    ],
                    timestamp: new Date().toISOString()
                });
            }
        }

        async function testEndpointsAvailability() {
            if (!isTokenValid()) {
                showToast('Token expired. Please login again.', 'error');
                logout();
                return;
            }

            const endpoints = [
                '/api/v1/export/excel',
                '/api/v1/export/excel/region/1',
                '/api/v1/export/excel/projects-only',
                '/api/v1/export/excel/notes-only'
            ];

            const results = {};
            showToast('üîç Testing endpoints...', 'warning');

            for (const endpoint of endpoints) {
                try {
                    const fullUrl = `${OAUTH_CONFIG.apiHost}${endpoint}`;
                    console.log('üß™ Testing endpoint:', fullUrl);
                    
                    const response = await fetch(fullUrl, {
                        method: 'HEAD',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        }
                    });
                    
                    results[endpoint] = {
                        status: response.status,
                        statusText: response.statusText,
                        available: response.ok,
                        headers: Object.fromEntries(response.headers.entries())
                    };
                    
                    console.log(`‚úÖ ${endpoint}: ${response.status} ${response.statusText}`);
                } catch (error) {
                    results[endpoint] = {
                        status: 'ERROR',
                        available: false,
                        error: error.message
                    };
                    console.error(`‚ùå ${endpoint}: ${error.message}`);
                }
            }

            const allAvailable = Object.values(results).every(r => r.available);
            
            if (allAvailable) {
                showToast('‚úÖ All endpoints available!', 'success');
            } else {
                showToast('‚ö†Ô∏è Some endpoints not available', 'warning');
            }

            showTestResponse({
                endpointTests: results,
                summary: {
                    total: endpoints.length,
                    available: Object.values(results).filter(r => r.available).length,
                    failed: Object.values(results).filter(r => !r.available).length
                },
                recommendations: [
                    "If endpoints return 404: Check if ExportController is properly configured",
                    "If endpoints return 500: Check server logs and database connection", 
                    "If endpoints return 401: Token might be invalid or expired",
                    "Make sure the 'exam.EXP' package is correctly included in your classpath"
                ],
                timestamp: new Date().toISOString()
            });
        }

        function showTokenInfo() {
            if (!accessToken) {
                showToast('No token available', 'error');
                return;
            }

            try {
                const payload = JSON.parse(atob(accessToken.split('.')[1]));
                showTestResponse({
                    tokenPayload: payload,
                    expiresAt: new Date(payload.exp * 1000).toISOString(),
                    issuedAt: new Date(payload.iat * 1000).toISOString(),
                    timeUntilExpiry: Math.floor((payload.exp * 1000 - Date.now()) / 1000) + ' seconds'
                });
            } catch (error) {
                showTestResponse({
                    error: 'Failed to decode token: ' + error.message
                });
            }
        }

        function showTestResponse(data) {
            const responseArea = document.getElementById('testResponse');
            const responseContent = document.getElementById('testResponseContent');

            responseContent.textContent = JSON.stringify(data, null, 2);
            responseArea.style.display = 'block';
            responseArea.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function isTokenValid() {
            return accessToken && userInfo.exp && Date.now() / 1000 < userInfo.exp;
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            if (event.key === '1' && event.ctrlKey) {
                event.preventDefault();
                if (!document.getElementById('exportCombinedBtn').disabled) {
                    exportCombined();
                }
            } else if (event.key === '2' && event.ctrlKey) {
                event.preventDefault();
                if (!document.getElementById('exportRegionBtn').disabled) {
                    exportByRegion();
                }
            } else if (event.key === '3' && event.ctrlKey) {
                event.preventDefault();
                if (!document.getElementById('exportProjectsBtn').disabled) {
                    exportProjectsOnly();
                }
            } else if (event.key === '4' && event.ctrlKey) {
                event.preventDefault();
                if (!document.getElementById('exportNotesBtn').disabled) {
                    exportNotesOnly();
                }
            } else if (event.key === 'h' && event.ctrlKey) {
                event.preventDefault();
                testApiHealth();
            }
        });

        // Token expiry monitoring
        setInterval(() => {
            if (accessToken && userInfo.exp) {
                const timeLeft = userInfo.exp * 1000 - Date.now();
                
                if (timeLeft <= 0) {
                    showToast('üïí Token expired. Please login again.', 'error');
                    logout();
                } else if (timeLeft <= 300000) { // 5 minutes warning
                    const minutesLeft = Math.floor(timeLeft / (1000 * 60));
                    showToast(`‚ö†Ô∏è Token expires in ${minutesLeft} minutes`, 'warning');
                }
                
                updateStats();
            }
        }, 30000); // Check every 30 seconds

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìä SimpleSalesman Excel Export GUI Initialized');
            console.log('üîß OAuth2/PKCE Authentication Flow Active');
            
            loadConfiguration();
            updateAuthStatus(false);
            updateStats();
            updateHistory();
            handleOAuthCallback();
            
            showToast('üöÄ Excel Export GUI loaded', 'success');
        });
    </script>
</body>
</html>