<!DOCTYPE html>
<html lang="de">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Simple Salesman GUI</title>
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Segoe+UI:400,700&display=swap">
	<style>
		body {
			margin: 0;
			font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			height: 100vh;
			display: flex;
			flex-direction: column;
		}
		.header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			padding: 18px 30px;
			background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
			color: white;
			font-size: 1.2rem;
		}
		.sidebar {
			width: 200px;
			background: #fff;
			box-shadow: 2px 0 12px rgba(0,0,0,0.08);
			padding-top: 18px;
			height: calc(100vh - 60px);
			position: fixed;
			top: 60px;
			left: 0;
			display: flex;
			flex-direction: column;
			gap: 10px;
			z-index: 1;
		}
		.sidebar button {
			margin: 0 12px 8px 12px;
			padding: 12px 0;
			border: none;
			border-radius: 8px;
			background: linear-gradient(135deg, #667eea, #764ba2);
			color: white;
			font-weight: bold;
			cursor: pointer;
			transition: all 0.2s;
		}
		.sidebar button:hover {
			transform: translateX(4px) scale(1.03);
			box-shadow: 0 3px 10px rgba(102, 126, 234, 0.15);
		}
		.sidebar button.active {
			background: linear-gradient(135deg, #4facfe, #00f2fe);
			transform: translateX(4px) scale(1.03);
		}
		.main {
			margin-left: 200px;
			padding: 32px 5vw;
			flex: 1;
		}
		.box {
			background: #fff;
			padding: 24px 28px;
			border-radius: 14px;
			box-shadow: 0 5px 20px rgba(0,0,0,0.09);
			max-width: 1200px;
			margin-bottom: 30px;
		}
		.section {
			display: none;
		}
		.section.active {
			display: block;
		}
		.list {
			display: flex;
			flex-wrap: wrap;
			gap: 10px;
			margin-bottom: 20px;
		}
		.list button {
			padding: 7px 17px;
			margin-bottom: 8px;
			border: none;
			border-radius: 6px;
			background: #f2f5ff;
			color: #222;
			font-weight: 500;
			cursor: pointer;
			transition: background 0.18s;
		}
		.list button.selected {
			background: #667eea;
			color: #fff;
		}
		.list button:hover {
			background: #e8f0ff;
		}
		.list button.selected:hover {
			background: #667eea;
		}
		.breadcrumb {
			background: #f8f9fa;
			padding: 10px 15px;
			border-radius: 6px;
			margin-bottom: 20px;
			font-size: 0.9rem;
			color: #666;
		}
		.breadcrumb .current {
			color: #667eea;
			font-weight: 600;
		}
		.back-button {
			padding: 6px 12px;
			margin-bottom: 15px;
			border: none;
			border-radius: 4px;
			background: #e9ecef;
			color: #495057;
			cursor: pointer;
			transition: background 0.2s;
		}
		.back-button:hover {
			background: #dee2e6;
		}

		/* Table Styles */
		.data-table {
			width: 100%;
			border-collapse: collapse;
			margin: 20px 0;
			background: white;
			border-radius: 8px;
			overflow: hidden;
			box-shadow: 0 2px 8px rgba(0,0,0,0.1);
		}
		.data-table th {
			background: linear-gradient(135deg, #667eea, #764ba2);
			color: white;
			padding: 12px 15px;
			text-align: left;
			cursor: pointer;
			user-select: none;
			transition: background 0.2s;
		}
		.data-table th:hover {
			background: linear-gradient(135deg, #5a6fd8, #6b42a0);
		}
		.data-table th.sorted-asc::after {
			content: " ↑";
			color: #fff;
		}
		.data-table th.sorted-desc::after {
			content: " ↓";
			color: #fff;
		}
		.data-table td {
			padding: 12px 15px;
			border-bottom: 1px solid #f1f3f4;
		}
		.data-table tr:hover {
			background: #f8f9fa;
		}
		.data-table tr:last-child td {
			border-bottom: none;
		}

		/* Project Tags */
		.project-tag {
			display: inline-block;
			background: #e7f3ff;
			color: #0066cc;
			padding: 3px 8px;
			border-radius: 12px;
			font-size: 0.8rem;
			margin: 2px;
		}

		/* Pagination */
		.pagination {
			display: flex;
			justify-content: center;
			gap: 10px;
			margin: 20px 0;
		}
		.pagination button {
			padding: 8px 12px;
			border: 1px solid #ddd;
			background: white;
			cursor: pointer;
			border-radius: 4px;
			transition: all 0.2s;
		}
		.pagination button:hover {
			background: #f0f0f0;
		}
		.pagination button.active {
			background: #667eea;
			color: white;
			border-color: #667eea;
		}
		.pagination button:disabled {
			opacity: 0.5;
			cursor: not-allowed;
		}

		/* Search and Filter */
		.table-controls {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 20px;
			flex-wrap: wrap;
			gap: 10px;
		}
		.search-input {
			padding: 8px 12px;
			border: 2px solid #e9ecef;
			border-radius: 6px;
			min-width: 200px;
			font-size: 14px;
		}
		.search-input:focus {
			outline: none;
			border-color: #667eea;
		}
		
		/* Modal/Popup Styles */
		.modal {
			display: none;
			position: fixed;
			z-index: 1000;
			left: 0;
			top: 0;
			width: 100%;
			height: 100%;
			background-color: rgba(0,0,0,0.5);
		}
		.modal-content {
			background-color: white;
			margin: 5% auto;
			padding: 30px;
			border-radius: 12px;
			width: 90%;
			max-width: 600px;
			max-height: 80vh;
			overflow-y: auto;
			box-shadow: 0 10px 40px rgba(0,0,0,0.2);
		}
		.modal-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 20px;
			padding-bottom: 15px;
			border-bottom: 2px solid #f1f3f4;
		}
		.modal-header h3 {
			margin: 0;
			color: #333;
		}
		.close {
			font-size: 28px;
			font-weight: bold;
			cursor: pointer;
			color: #aaa;
			transition: color 0.2s;
		}
		.close:hover {
			color: #667eea;
		}
		.note-list {
			background: #f8f9fa;
			border-radius: 8px;
			padding: 15px;
			margin-bottom: 20px;
			max-height: 200px;
			overflow-y: auto;
		}
		.note-item {
			padding: 8px 0;
			border-bottom: 1px solid #e3e6f0;
			font-size: 0.95rem;
		}
		.note-item:last-child { 
			border-bottom: none; 
		}
		.note-meta {
			font-size: 0.8rem;
			color: #666;
			margin-top: 2px;
		}
		.note-form textarea {
			width: 100%;
			min-height: 80px;
			border-radius: 6px;
			border: 1.7px solid #e9ecef;
			padding: 12px;
			font-size: 1rem;
			margin-bottom: 15px;
			resize: vertical;
			font-family: inherit;
		}
		.note-form button {
			padding: 10px 20px;
			border: none;
			border-radius: 6px;
			background: linear-gradient(135deg, #667eea, #764ba2);
			color: white;
			font-weight: 600;
			cursor: pointer;
			float: right;
		}
		
		.import-form {
			display: flex;
			flex-direction: column;
			gap: 15px;
		}
		.file-input {
			padding: 20px;
			border: 2px dashed #e9ecef;
			border-radius: 8px;
			text-align: center;
			cursor: pointer;
			transition: border-color 0.2s;
		}
		.file-input:hover {
			border-color: #667eea;
		}
		.btn {
			padding: 10px 20px;
			border: none;
			border-radius: 6px;
			background: linear-gradient(135deg, #667eea, #764ba2);
			color: white;
			font-weight: 600;
			cursor: pointer;
			transition: transform 0.2s;
		}
		.btn:hover {
			transform: scale(1.02);
		}
		.weather-info {
			font-size: 1.1rem;
			padding: 15px;
			background: #f8f9fa;
			border-radius: 8px;
			margin-bottom: 15px;
		}
		.project-grid {
			display: grid;
			grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
			gap: 20px;
		}
		.project-card {
			background: #f8f9fa;
			padding: 20px;
			border-radius: 8px;
			border-left: 4px solid #667eea;
		}
		.loading {
			text-align: center;
			color: #666;
			font-style: italic;
		}
		#weather { font-size: 1.05rem; }

		/* Toggle buttons for different views */
		.view-toggle {
			margin-bottom: 20px;
		}
		.view-toggle button {
			padding: 8px 16px;
			border: 1px solid #667eea;
			background: white;
			color: #667eea;
			cursor: pointer;
			margin-right: 5px;
			border-radius: 4px;
			transition: all 0.2s;
		}
		.view-toggle button.active {
			background: #667eea;
			color: white;
		}
		.view-toggle button:hover {
			background: #5a6fd8;
			color: white;
		}

		@media (max-width: 800px) {
			.sidebar { display: none; }
			.main { margin-left: 0; }
			.modal-content {
				margin: 10% auto;
				width: 95%;
				padding: 20px;
			}
			.data-table {
				font-size: 0.9rem;
			}
			.data-table th, .data-table td {
				padding: 8px 10px;
			}
			.table-controls {
				flex-direction: column;
				align-items: stretch;
			}
		}
	</style>
</head>
<body>
	<div class="header">
		<div>Simple Salesman GUI</div>
		<div>
			<span id="username">User</span> | 
			<span id="weather">Wetter wird geladen…</span>
		</div>
	</div>
	<div class="sidebar">
		<button onclick="showSection('addresses')" class="active" id="btn-addresses">Adressen</button>
		<button onclick="showSection('notes')" id="btn-notes">Notizen</button>
		<button onclick="showSection('projects')" id="btn-projects">Projekte</button>
		<button onclick="showSection('import')" id="btn-import">Import</button>
		<button onclick="showSection('weather')" id="btn-weather">Wetter</button>
	</div>
	<div class="main">
		<!-- Adressen Sektion -->
		<div class="section active" id="addressesSection">
			<!-- View Toggle -->
			<div class="view-toggle">
				<button onclick="showAddressView('table')" class="active" id="view-table">Tabellenansicht</button>
				<button onclick="showAddressView('navigation')" id="view-navigation">Navigation</button>
			</div>

			<!-- Neue Adressen-Tabelle -->
			<div class="box" id="addressesTableBox">
				<h2>Alle Adressen</h2>
				<div class="table-controls">
					<input type="text" id="addressSearchInput" class="search-input" placeholder="Suche nach Adresse..." onkeyup="filterAddressTable()">
					<div>
						<span>Zeige </span>
						<select id="addressPageSize" onchange="changeAddressPageSize()">
							<option value="10">10</option>
							<option value="20" selected>20</option>
							<option value="50">50</option>
						</select>
						<span> Einträge</span>
					</div>
				</div>
				<table id="addressesTable" class="data-table">
					<thead>
						<tr>
							<th onclick="sortAddressTable('plz')">PLZ</th>
							<th onclick="sortAddressTable('street')">Straße</th>
							<th onclick="sortAddressTable('number')">Hausnummer</th>
							<th onclick="sortAddressTable('region')">Region</th>
							<th>Projekte</th>
							<th>Aktionen</th>
						</tr>
					</thead>
					<tbody>
						<tr><td colspan="6" class="loading">Adressen werden geladen...</td></tr>
					</tbody>
				</table>
				<div id="addressesPagination" class="pagination"></div>
			</div>

			<!-- Bestehende PLZ-Navigation (ausblendbar) -->
			<div class="box" id="addressesNavigationBox" style="display:none;">
				<h2>Adresse auswählen</h2>
				
				<!-- Breadcrumb Navigation -->
				<div class="breadcrumb" id="breadcrumb">
					<span class="current">PLZ auswählen</span>
				</div>
				
				<!-- Back Button (initially hidden) -->
				<button class="back-button" id="backButton" onclick="goBack()" style="display:none;">
					← Zurück
				</button>
				
				<!-- PLZ Selection -->
				<div id="plzSelection">
					<b>Verfügbare Postleitzahlen:</b>
					<div class="list" id="plzList">
						<p class="loading">PLZs werden geladen...</p>
					</div>
				</div>
				
				<!-- Street Selection (initially hidden) -->
				<div id="streetSelection" style="display:none;">
					<b>Straßen:</b>
					<div class="list" id="streetList"></div>
				</div>
				
				<!-- House Number Selection (initially hidden) -->
				<div id="numberSelection" style="display:none;">
					<b>Hausnummern:</b>
					<div class="list" id="numberList"></div>
				</div>
			</div>
		</div>

		<!-- Notizen Sektion -->
		<div class="section" id="notesSection">
			<div class="box">
				<h2>Alle Notizen</h2>
				<div class="table-controls">
					<input type="text" id="notesSearchInput" class="search-input" placeholder="Suche in Notizen..." onkeyup="filterNotesTable()">
					<div>
						<span>Zeige </span>
						<select id="notesPageSize" onchange="changeNotesPageSize()">
							<option value="10">10</option>
							<option value="20" selected>20</option>
							<option value="50">50</option>
						</select>
						<span> Einträge</span>
					</div>
				</div>
				<table id="notesTable" class="data-table">
					<thead>
						<tr>
							<th onclick="sortNotesTable('id')">ID</th>
							<th onclick="sortNotesTable('address')">Adresse</th>
							<th onclick="sortNotesTable('text')">Notiztext</th>
							<th onclick="sortNotesTable('createdBy')">Erstellt von</th>
							<th onclick="sortNotesTable('createdAt')">Datum</th>
							<th>Aktionen</th>
						</tr>
					</thead>
					<tbody>
						<tr><td colspan="6" class="loading">Notizen werden geladen...</td></tr>
					</tbody>
				</table>
				<div id="notesPagination" class="pagination"></div>
			</div>
		</div>

		<!-- Projekte Sektion -->
		<div class="section" id="projectsSection">
			<div class="box">
				<h2>Projekte</h2>
				<div class="project-grid" id="projectGrid">
					<p class="loading">Projekte werden geladen...</p>
				</div>
			</div>
		</div>

		<!-- Import Sektion -->
		<div class="section" id="importSection">
			<div class="box">
				<h2>Excel Import</h2>
				<form class="import-form" id="importForm">
					<div class="file-input" onclick="document.getElementById('fileInput').click()">
						<input type="file" id="fileInput" accept=".xlsx,.xls" style="display:none;">
						<p>Klicken Sie hier oder ziehen Sie eine Excel-Datei hierher</p>
						<small>Unterstützte Formate: .xlsx, .xls</small>
					</div>
					<button type="submit" class="btn">Datei importieren</button>
				</form>
				<div id="importResult" style="margin-top: 20px;"></div>
			</div>
		</div>

		<!-- Wetter Sektion -->
		<div class="section" id="weatherSection">
			<div class="box">
				<h2>Wetter Information</h2>
				<div class="weather-info" id="weatherInfo">
					<p class="loading">Wetter wird geladen...</p>
				</div>
				<div>
					<h3>Wetter für Region abfragen</h3>
					<input type="text" id="regionInput" placeholder="Region eingeben (z.B. Linz)" style="padding:8px; margin-right:10px;">
					<button onclick="fetchWeatherByRegion()" class="btn">Wetter abrufen</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Notes Modal -->
	<div id="notesModal" class="modal">
		<div class="modal-content">
			<div class="modal-header">
				<h3 id="modalTitle">Notizen für Adresse</h3>
				<span class="close" onclick="closeNotesModal()">&times;</span>
			</div>
			<div class="modal-body">
				<div class="note-list" id="modalNoteList">
					<p class="loading">Notizen werden geladen...</p>
				</div>
				<form class="note-form" id="modalNoteForm">
					<textarea id="modalNewNote" placeholder="Neue Notiz schreiben..."></textarea>
					<button type="submit">Notiz speichern</button>
					<div style="clear:both;"></div>
				</form>
			</div>
		</div>
	</div>

	<script>
		// ----------- Global Variables -----------
		let allAddresses = [];
		let allNotes = [];
		let allProjects = [];
		let currentStep = 'plz'; // 'plz', 'street', 'number'
		let selectedPlz = null;
		let selectedStreet = null;
		let selectedNumber = null;
		let selectedAddressId = null;

		// Table state
		let currentAddressView = 'table';
		let addressTableState = {
			currentPage: 1,
			pageSize: 20,
			sortField: 'plz',
			sortOrder: 'asc',
			searchTerm: ''
		};
		let notesTableState = {
			currentPage: 1,
			pageSize: 20,
			sortField: 'id',
			sortOrder: 'desc',
			searchTerm: ''
		};

		// ----------- USERNAME aus Token -----------
		document.getElementById('username').textContent = sessionStorage.getItem('username') || 'User';

		// ----------- Initial Load -----------
		window.addEventListener('load', function() {
			const token = sessionStorage.getItem('access_token');
			if (!token) {
				console.warn('Kein access_token im sessionStorage gefunden. Versuche ohne Token...');
			}
			
			loadAllAddresses();
			loadAllNotes();
			loadWeatherData();
			
			if (window.location.search.includes('debug=true')) {
				showDebugInfo();
			}
		});

		function showDebugInfo() {
			console.log('=== SimpleSalesman Debug Info ===');
			console.log('Token im sessionStorage:', !!sessionStorage.getItem('access_token'));
			console.log('Username:', sessionStorage.getItem('username'));
			console.log('Backend URL:', window.location.origin);
			
			const debugBtn = document.createElement('button');
			debugBtn.textContent = 'Debug: Show Data';
			debugBtn.style.position = 'fixed';
			debugBtn.style.top = '10px';
			debugBtn.style.right = '10px';
			debugBtn.style.zIndex = '9999';
			debugBtn.onclick = () => {
				console.log('Addresses:', allAddresses);
				console.log('Notes:', allNotes);
				alert(`${allAddresses.length} Adressen, ${allNotes.length} Notizen geladen.`);
			};
			document.body.appendChild(debugBtn);
		}

		// ----------- Address Loading and Table Management -----------
		async function loadAllAddresses() {
			try {
				const token = sessionStorage.getItem('access_token');
				const headers = token ? { 'Authorization': 'Bearer ' + token } : {};
				
				const res = await fetch('/api/v1/addresses', { headers });
				
				if (!res.ok) {
					throw new Error(`HTTP ${res.status}: ${res.statusText}`);
				}
				
				allAddresses = await res.json();
				renderAddressesTable();
				showAllPlzs(); // For navigation view
			} catch (error) {
				console.error('Fehler beim Laden der Adressen:', error);
				document.querySelector('#addressesTable tbody').innerHTML = 
					`<tr><td colspan="6" style="color:red;">Fehler: ${error.message}</td></tr>`;
			}
		}

		async function loadAllNotes() {
			try {
				const token = sessionStorage.getItem('access_token');
				const headers = token ? { 'Authorization': 'Bearer ' + token } : {};
				
				// Load all notes by getting notes for each address
				allNotes = [];
				for (const address of allAddresses) {
					const res = await fetch(`/api/v1/notes/${address.id}`, { headers });
					if (res.ok) {
						const notes = await res.json();
						notes.forEach(note => {
							note.address = address; // Add address reference
						});
						allNotes.push(...notes);
					}
				}
				renderNotesTable();
			} catch (error) {
				console.error('Fehler beim Laden der Notizen:', error);
				document.querySelector('#notesTable tbody').innerHTML = 
					`<tr><td colspan="6" style="color:red;">Fehler: ${error.message}</td></tr>`;
			}
		}

		// ----------- Address Table Functions -----------
		function renderAddressesTable() {
			const { currentPage, pageSize, sortField, sortOrder, searchTerm } = addressTableState;
			
			// Filter addresses
			let filteredAddresses = allAddresses.filter(addr => {
				if (!searchTerm) return true;
				const searchString = `${extractPlz(addr)} ${extractStreet(addr)} ${extractNumber(addr)} ${addr.regionName || ''}`.toLowerCase();
				return searchString.includes(searchTerm.toLowerCase());
			});

			// Sort addresses
			filteredAddresses.sort((a, b) => {
				let aVal, bVal;
				switch(sortField) {
					case 'plz':
						aVal = extractPlz(a) || '';
						bVal = extractPlz(b) || '';
						break;
					case 'street':
						aVal = extractStreet(a) || '';
						bVal = extractStreet(b) || '';
						break;
					case 'number':
						aVal = extractNumber(a) || '';
						bVal = extractNumber(b) || '';
						break;
					case 'region':
						aVal = a.regionName || '';
						bVal = b.regionName || '';
						break;
					default:
						aVal = a.addressText || '';
						bVal = b.addressText || '';
				}
				
				const comparison = aVal.toString().localeCompare(bVal.toString(), 'de', { numeric: true });
				return sortOrder === 'asc' ? comparison : -comparison;
			});

			// Paginate
			const totalPages = Math.ceil(filteredAddresses.length / pageSize);
			const startIndex = (currentPage - 1) * pageSize;
			const paginatedAddresses = filteredAddresses.slice(startIndex, startIndex + pageSize);

			// Render table
			const tbody = document.querySelector('#addressesTable tbody');
			tbody.innerHTML = '';

			if (paginatedAddresses.length === 0) {
				tbody.innerHTML = '<tr><td colspan="6" class="loading">Keine Adressen gefunden</td></tr>';
			} else {
				paginatedAddresses.forEach(addr => {
					const projects = (addr.projects || []).map(p => 
						`<span class="project-tag">${p.status || 'Unbekannt'}</span>`
					).join('');

					tbody.innerHTML += `
						<tr>
							<td>${extractPlz(addr) || '-'}</td>
							<td>${extractStreet(addr) || '-'}</td>
							<td>${extractNumber(addr) || '-'}</td>
							<td>${addr.regionName || '-'}</td>
							<td>${projects || '-'}</td>
							<td>
								<button onclick="openNotesModalForAddress(${addr.id})" style="background:#667eea;color:white;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;">
									Notizen
								</button>
							</td>
						</tr>
					`;
				});
			}

			// Update sort indicators
			document.querySelectorAll('#addressesTable th').forEach(th => {
				th.classList.remove('sorted-asc', 'sorted-desc');
			});
			const sortedTh = document.querySelector(`#addressesTable th[onclick="sortAddressTable('${sortField}')"]`);
			if (sortedTh) {
				sortedTh.classList.add(`sorted-${sortOrder}`);
			}

			// Render pagination
			renderAddressPagination(totalPages);
		}

		function renderAddressPagination(totalPages) {
			const pagination = document.getElementById('addressesPagination');
			pagination.innerHTML = '';

			if (totalPages <= 1) return;

			const { currentPage } = addressTableState;

			// Previous button
			const prevBtn = document.createElement('button');
			prevBtn.textContent = '‹ Zurück';
			prevBtn.disabled = currentPage === 1;
			prevBtn.onclick = () => {
				if (currentPage > 1) {
					addressTableState.currentPage--;
					renderAddressesTable();
				}
			};
			pagination.appendChild(prevBtn);

			// Page numbers
			const maxVisiblePages = 5;
			let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
			let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

			if (endPage - startPage + 1 < maxVisiblePages) {
				startPage = Math.max(1, endPage - maxVisiblePages + 1);
			}

			for (let page = startPage; page <= endPage; page++) {
				const pageBtn = document.createElement('button');
				pageBtn.textContent = page;
				pageBtn.className = page === currentPage ? 'active' : '';
				pageBtn.onclick = () => {
					addressTableState.currentPage = page;
					renderAddressesTable();
				};
				pagination.appendChild(pageBtn);
			}

			// Next button
			const nextBtn = document.createElement('button');
			nextBtn.textContent = 'Weiter ›';
			nextBtn.disabled = currentPage === totalPages;
			nextBtn.onclick = () => {
				if (currentPage < totalPages) {
					addressTableState.currentPage++;
					renderAddressesTable();
				}
			};
			pagination.appendChild(nextBtn);
		}

		function sortAddressTable(field) {
			if (addressTableState.sortField === field) {
				addressTableState.sortOrder = addressTableState.sortOrder === 'asc' ? 'desc' : 'asc';
			} else {
				addressTableState.sortField = field;
				addressTableState.sortOrder = 'asc';
			}
			addressTableState.currentPage = 1;
			renderAddressesTable();
		}

		function filterAddressTable() {
			addressTableState.searchTerm = document.getElementById('addressSearchInput').value;
			addressTableState.currentPage = 1;
			renderAddressesTable();
		}

		function changeAddressPageSize() {
			addressTableState.pageSize = parseInt(document.getElementById('addressPageSize').value);
			addressTableState.currentPage = 1;
			renderAddressesTable();
		}

		// ----------- Notes Table Functions -----------
		function renderNotesTable() {
			const { currentPage, pageSize, sortField, sortOrder, searchTerm } = notesTableState;
			
			// Filter notes
			let filteredNotes = allNotes.filter(note => {
				if (!searchTerm) return true;
				const searchString = `${note.text || ''} ${note.createdBy || ''} ${getAddressString(note.address)}`.toLowerCase();
				return searchString.includes(searchTerm.toLowerCase());
			});

			// Sort notes
			filteredNotes.sort((a, b) => {
				let aVal, bVal;
				switch(sortField) {
					case 'id':
						aVal = a.id || 0;
						bVal = b.id || 0;
						break;
					case 'address':
						aVal = getAddressString(a.address);
						bVal = getAddressString(b.address);
						break;
					case 'text':
						aVal = a.text || '';
						bVal = b.text || '';
						break;
					case 'createdBy':
						aVal = a.createdBy || '';
						bVal = b.createdBy || '';
						break;
					case 'createdAt':
						aVal = new Date(a.createdAt || 0);
						bVal = new Date(b.createdAt || 0);
						break;
					default:
						aVal = a.id || 0;
						bVal = b.id || 0;
				}
				
				if (sortField === 'createdAt' || sortField === 'id') {
					return sortOrder === 'asc' ? aVal - bVal : bVal - aVal;
				} else {
					const comparison = aVal.toString().localeCompare(bVal.toString(), 'de');
					return sortOrder === 'asc' ? comparison : -comparison;
				}
			});

			// Paginate
			const totalPages = Math.ceil(filteredNotes.length / pageSize);
			const startIndex = (currentPage - 1) * pageSize;
			const paginatedNotes = filteredNotes.slice(startIndex, startIndex + pageSize);

			// Render table
			const tbody = document.querySelector('#notesTable tbody');
			tbody.innerHTML = '';

			if (paginatedNotes.length === 0) {
				tbody.innerHTML = '<tr><td colspan="6" class="loading">Keine Notizen gefunden</td></tr>';
			} else {
				paginatedNotes.forEach(note => {
					const addressStr = getAddressString(note.address);
					const dateStr = note.createdAt ? new Date(note.createdAt).toLocaleString('de-DE') : '-';
					const textPreview = (note.text || '').length > 100 ? 
						(note.text || '').substring(0, 100) + '...' : 
						(note.text || '');

					tbody.innerHTML += `
						<tr>
							<td>${note.id || '-'}</td>
							<td>${addressStr}</td>
							<td title="${note.text || ''}">${textPreview}</td>
							<td>${note.createdBy || '-'}</td>
							<td>${dateStr}</td>
							<td>
								<button onclick="openNotesModalForAddress(${note.address?.id})" style="background:#667eea;color:white;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;margin-right:4px;">
									Anzeigen
								</button>
							</td>
						</tr>
					`;
				});
			}

			// Update sort indicators
			document.querySelectorAll('#notesTable th').forEach(th => {
				th.classList.remove('sorted-asc', 'sorted-desc');
			});
			const sortedTh = document.querySelector(`#notesTable th[onclick="sortNotesTable('${sortField}')"]`);
			if (sortedTh) {
				sortedTh.classList.add(`sorted-${sortOrder}`);
			}

			// Render pagination
			renderNotesPagination(totalPages);
		}

		function renderNotesPagination(totalPages) {
			const pagination = document.getElementById('notesPagination');
			pagination.innerHTML = '';

			if (totalPages <= 1) return;

			const { currentPage } = notesTableState;

			// Previous button
			const prevBtn = document.createElement('button');
			prevBtn.textContent = '‹ Zurück';
			prevBtn.disabled = currentPage === 1;
			prevBtn.onclick = () => {
				if (currentPage > 1) {
					notesTableState.currentPage--;
					renderNotesTable();
				}
			};
			pagination.appendChild(prevBtn);

			// Page numbers
			const maxVisiblePages = 5;
			let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
			let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

			for (let page = startPage; page <= endPage; page++) {
				const pageBtn = document.createElement('button');
				pageBtn.textContent = page;
				pageBtn.className = page === currentPage ? 'active' : '';
				pageBtn.onclick = () => {
					notesTableState.currentPage = page;
					renderNotesTable();
				};
				pagination.appendChild(pageBtn);
			}

			// Next button
			const nextBtn = document.createElement('button');
			nextBtn.textContent = 'Weiter ›';
			nextBtn.disabled = currentPage === totalPages;
			nextBtn.onclick = () => {
				if (currentPage < totalPages) {
					notesTableState.currentPage++;
					renderNotesTable();
				}
			};
			pagination.appendChild(nextBtn);
		}

		function sortNotesTable(field) {
			if (notesTableState.sortField === field) {
				notesTableState.sortOrder = notesTableState.sortOrder === 'asc' ? 'desc' : 'asc';
			} else {
				notesTableState.sortField = field;
				notesTableState.sortOrder = field === 'createdAt' || field === 'id' ? 'desc' : 'asc';
			}
			notesTableState.currentPage = 1;
			renderNotesTable();
		}

		function filterNotesTable() {
			notesTableState.searchTerm = document.getElementById('notesSearchInput').value;
			notesTableState.currentPage = 1;
			renderNotesTable();
		}

		function changeNotesPageSize() {
			notesTableState.pageSize = parseInt(document.getElementById('notesPageSize').value);
			notesTableState.currentPage = 1;
			renderNotesTable();
		}

		// ----------- Helper Functions -----------
		function extractPlz(address) {
			return address.postalCode || address.plz || extractFromAddressText(address.addressText, /\b\d{4,5}\b/);
		}

		function extractStreet(address) {
			if (address.street) return address.street;
			if (address.addressText) {
				// Try to extract street name before house number
				const match = address.addressText.match(/^([^,\d]+)/);
				return match ? match[1].trim() : address.addressText.split(',')[0].trim();
			}
			return '';
		}

		function extractNumber(address) {
			return address.houseNumber || extractFromAddressText(address.addressText, /\d+[a-zA-Z]*/);
		}

		function extractFromAddressText(addressText, regex) {
			if (!addressText) return '';
			const match = addressText.match(regex);
			return match ? match[0] : '';
		}

		function getAddressString(address) {
			if (!address) return '-';
			const plz = extractPlz(address);
			const street = extractStreet(address);
			const number = extractNumber(address);
			return `${plz} ${street} ${number}`.trim();
		}

		// ----------- View Toggle Functions -----------
		function showAddressView(view) {
			currentAddressView = view;
			
			// Update toggle buttons
			document.querySelectorAll('.view-toggle button').forEach(btn => btn.classList.remove('active'));
			document.getElementById(`view-${view}`).classList.add('active');

			// Show/hide appropriate boxes
			if (view === 'table') {
				document.getElementById('addressesTableBox').style.display = 'block';
				document.getElementById('addressesNavigationBox').style.display = 'none';
			} else {
				document.getElementById('addressesTableBox').style.display = 'none';
				document.getElementById('addressesNavigationBox').style.display = 'block';
			}
		}

		// ----------- Modal Functions -----------
		function openNotesModalForAddress(addressId) {
			selectedAddressId = addressId;
			const address = allAddresses.find(a => a.id === addressId);
			if (address) {
				document.getElementById('modalTitle').textContent = `Notizen für ${getAddressString(address)}`;
				document.getElementById('notesModal').style.display = 'block';
				loadNotesInModal();
			}
		}

		function closeNotesModal() {
			document.getElementById('notesModal').style.display = 'none';
			document.getElementById('modalNewNote').value = '';
		}

		async function loadNotesInModal() {
			try {
				const token = sessionStorage.getItem('access_token');
				const headers = token ? { 'Authorization': 'Bearer ' + token } : {};
				
				const res = await fetch(`/api/v1/notes/${selectedAddressId}`, { headers });
				
				if (!res.ok) {
					throw new Error(`HTTP ${res.status}: ${res.statusText}`);
				}
				
				const notes = await res.json();
				
				const el = document.getElementById('modalNoteList');
				el.innerHTML = '';
				
				if (notes.length === 0) {
					el.innerHTML = '<p><i>Keine Notizen vorhanden.</i></p>';
				} else {
					notes.forEach(note => {
						const div = document.createElement('div');
						div.className = 'note-item';
						
						const noteText = note.text || note.content || note.description || 'Notiz ohne Text';
						const creator = note.createdBy || note.author || note.user || 'Unbekannt';
						const timestamp = note.createdAt || note.timestamp || note.created;
						
						let timeString = '';
						if (timestamp) {
							try {
								timeString = ' | ' + new Date(timestamp).toLocaleString('de-DE');
							} catch (e) {
								timeString = ` | ${timestamp}`;
							}
						}
						
						div.innerHTML = `
							<div>${noteText}</div>
							<div class="note-meta">Von: ${creator}${timeString}</div>
						`;
						el.appendChild(div);
					});
				}
			} catch (error) {
				console.error('Fehler beim Laden der Notizen:', error);
				document.getElementById('modalNoteList').innerHTML = 
					`<p style="color:red;">Fehler beim Laden der Notizen: ${error.message}</p>`;
			}
		}

		// Modal form submission
		document.getElementById('modalNoteForm').addEventListener('submit', async function(e) {
			e.preventDefault();
			const text = document.getElementById('modalNewNote').value.trim();
			if (!text || !selectedAddressId) {
				alert('Bitte geben Sie einen Notiztext ein.');
				return;
			}

			try {
				const token = sessionStorage.getItem('access_token');
				const headers = {
					'Content-Type': 'application/json'
				};
				
				if (token) {
					headers['Authorization'] = 'Bearer ' + token;
				}
				
				const requestBody = {
					text: text,
					createdBy: sessionStorage.getItem('username') || 'Unbekannt'
				};
				
				const res = await fetch(`/api/v1/notes/${selectedAddressId}`, {
					method: 'POST',
					headers: headers,
					body: JSON.stringify(requestBody)
				});

				if (res.ok) {
					document.getElementById('modalNewNote').value = '';
					await loadNotesInModal();
					await loadAllNotes(); // Refresh notes table
					
					const successMsg = document.createElement('div');
					successMsg.style.color = 'green';
					successMsg.style.marginTop = '10px';
					successMsg.textContent = 'Notiz erfolgreich gespeichert!';
					document.querySelector('.modal-body').appendChild(successMsg);
					setTimeout(() => successMsg.remove(), 3000);
				} else {
					const errorText = await res.text();
					throw new Error(`HTTP ${res.status}: ${errorText || res.statusText}`);
				}
			} catch (error) {
				console.error('Fehler beim Speichern der Notiz:', error);
				alert(`Fehler beim Speichern der Notiz: ${error.message}`);
			}
		});

		// Close modal when clicking outside
		window.onclick = function(event) {
			const modal = document.getElementById('notesModal');
			if (event.target === modal) {
				closeNotesModal();
			}
		}

		// ----------- Original Navigation Functions (preserved) -----------
		function showAllPlzs() {
			const plzs = [...new Set(allAddresses
				.map(a => extractPlz(a))
				.filter(plz => plz)
			)].sort();
			
			const el = document.getElementById('plzList');
			el.innerHTML = '';
			
			if (plzs.length === 0) {
				el.innerHTML = '<p>Keine PLZs verfügbar. Laden Sie zuerst Daten über den Import.</p>';
				return;
			}
			
			plzs.forEach(plz => {
				const btn = document.createElement('button');
				btn.textContent = plz;
				btn.onclick = () => selectPlz(plz);
				el.appendChild(btn);
			});
		}

		function selectPlz(plz) {
			selectedPlz = plz;
			selectedStreet = null;
			selectedNumber = null;
			currentStep = 'street';
			
			document.getElementById('breadcrumb').innerHTML = 
				`PLZ: ${plz} > <span class="current">Straße auswählen</span>`;
			
			document.getElementById('backButton').style.display = 'block';
			document.getElementById('plzSelection').style.display = 'none';
			document.getElementById('streetSelection').style.display = 'block';
			document.getElementById('numberSelection').style.display = 'none';
			
			const streets = [...new Set(allAddresses
				.filter(a => extractPlz(a) == plz)
				.map(a => extractStreet(a))
				.filter(street => street)
			)].sort();
			
			showStreets(streets);
		}

		function showStreets(streets) {
			const el = document.getElementById('streetList');
			el.innerHTML = '';
			
			streets.forEach(street => {
				const btn = document.createElement('button');
				btn.textContent = street;
				btn.onclick = () => selectStreet(street);
				el.appendChild(btn);
			});
		}

		function selectStreet(street) {
			selectedStreet = street;
			selectedNumber = null;
			currentStep = 'number';
			
			document.getElementById('breadcrumb').innerHTML = 
				`PLZ: ${selectedPlz} > Straße: ${street} > <span class="current">Hausnummer auswählen</span>`;
			
			document.getElementById('streetSelection').style.display = 'none';
			document.getElementById('numberSelection').style.display = 'block';
			
			const numbers = allAddresses
				.filter(a => {
					const plzMatch = extractPlz(a) == selectedPlz;
					const streetMatch = extractStreet(a) === street;
					return plzMatch && streetMatch;
				})
				.map(a => extractNumber(a))
				.filter(number => number)
				.sort((a, b) => {
					const numA = parseInt(a);
					const numB = parseInt(b);
					if (!isNaN(numA) && !isNaN(numB)) {
						return numA - numB;
					}
					return a.localeCompare(b);
				});
			
			showNumbers(numbers);
		}

		function showNumbers(numbers) {
			const el = document.getElementById('numberList');
			el.innerHTML = '';
			
			numbers.forEach(number => {
				const btn = document.createElement('button');
				btn.textContent = number;
				btn.onclick = () => selectNumber(number);
				el.appendChild(btn);
			});
		}

		function selectNumber(number) {
			selectedNumber = number;
			
			const address = allAddresses.find(a => {
				const plzMatch = extractPlz(a) == selectedPlz;
				const streetMatch = extractStreet(a) === selectedStreet;
				const numberMatch = extractNumber(a) === number;
				return plzMatch && streetMatch && numberMatch;
			});
			
			if (address) {
				selectedAddressId = address.id;
				openNotesModal();
			} else {
				alert('Adresse konnte nicht gefunden werden. Bitte versuchen Sie es erneut.');
			}
		}

		function goBack() {
			if (currentStep === 'street') {
				currentStep = 'plz';
				selectedPlz = null;
				document.getElementById('breadcrumb').innerHTML = '<span class="current">PLZ auswählen</span>';
				document.getElementById('backButton').style.display = 'none';
				document.getElementById('plzSelection').style.display = 'block';
				document.getElementById('streetSelection').style.display = 'none';
				document.getElementById('numberSelection').style.display = 'none';
			} else if (currentStep === 'number') {
				currentStep = 'street';
				selectedStreet = null;
				document.getElementById('breadcrumb').innerHTML = 
					`PLZ: ${selectedPlz} > <span class="current">Straße auswählen</span>`;
				document.getElementById('streetSelection').style.display = 'block';
				document.getElementById('numberSelection').style.display = 'none';
			}
		}

		function openNotesModal() {
			const addressText = `${selectedPlz} ${selectedStreet} ${selectedNumber}`;
			document.getElementById('modalTitle').textContent = `Notizen für ${addressText}`;
			document.getElementById('notesModal').style.display = 'block';
			loadNotesInModal();
		}

		// ----------- Weather Functions -----------
		async function loadWeatherData() {
			if (navigator.geolocation) {
				navigator.geolocation.getCurrentPosition(async (pos) => {
					const lat = pos.coords.latitude;
					const lon = pos.coords.longitude;
					try {
						const token = sessionStorage.getItem('access_token');
						const headers = token ? { 'Authorization': 'Bearer ' + token } : {};
						
						const res = await fetch(`/api/v1/weather?lat=${lat}&lon=${lon}`, { headers });
						const weatherText = await res.text();
						document.getElementById('weather').textContent = weatherText;
						document.getElementById('weatherInfo').innerHTML = `<p><strong>Aktueller Standort:</strong> ${weatherText}</p>`;
					} catch (error) {
						console.error('Fehler beim Laden der Wetterdaten:', error);
						document.getElementById('weather').textContent = 'Wetter nicht verfügbar';
					}
				}, () => {
					document.getElementById('weather').textContent = 'Standort nicht verfügbar';
				});
			} else {
				document.getElementById('weather').textContent = 'Geolocation nicht unterstützt';
			}
		}

		async function fetchWeatherByRegion() {
			const region = document.getElementById('regionInput').value.trim();
			if (!region) return;

			try {
				const token = sessionStorage.getItem('access_token');
				const headers = token ? { 'Authorization': 'Bearer ' + token } : {};
				
				const res = await fetch(`/api/v1/weather?region=${encodeURIComponent(region)}`, { headers });
				const weatherText = await res.text();
				document.getElementById('weatherInfo').innerHTML = `<p><strong>${region}:</strong> ${weatherText}</p>`;
			} catch (error) {
				console.error('Fehler beim Laden der Wetterdaten:', error);
				document.getElementById('weatherInfo').innerHTML = '<p>Fehler beim Laden der Wetterdaten</p>';
			}
		}

		// ----------- Section Navigation -----------
		function showSection(sectionName) {
			document.querySelectorAll('.section').forEach(section => {
				section.classList.remove('active');
			});
			
			document.querySelectorAll('.sidebar button').forEach(btn => {
				btn.classList.remove('active');
			});
			
			document.getElementById(sectionName + 'Section').classList.add('active');
			document.getElementById('btn-' + sectionName).classList.add('active');
			
			if (sectionName === 'projects') {
				loadProjects();
			} else if (sectionName === 'weather') {
				loadWeatherData();
			} else if (sectionName === 'notes' && allNotes.length === 0) {
				loadAllNotes();
			}
		}

		// ----------- Project Functions -----------
		async function loadProjects() {
			try {
				const token = sessionStorage.getItem('access_token');
				const headers = token ? { 'Authorization': 'Bearer ' + token } : {};
				
				const res = await fetch('/api/v1/projects', { headers });
				
				if (res.ok) {
					const projects = await res.json();
					displayProjects(projects);
				} else {
					document.getElementById('projectGrid').innerHTML = '<p>Fehler beim Laden der Projekte</p>';
				}
			} catch (error) {
				console.error('Fehler beim Laden der Projekte:', error);
				document.getElementById('projectGrid').innerHTML = '<p>Projekt-Funktionalität wird implementiert...</p>';
			}
		}

		function displayProjects(projects) {
			const grid = document.getElementById('projectGrid');
			grid.innerHTML = '';
			
			if (projects.length === 0) {
				grid.innerHTML = '<p>Keine Projekte gefunden.</p>';
				return;
			}
			
			projects.forEach(project => {
				const card = document.createElement('div');
				card.className = 'project-card';
				card.innerHTML = `
					<h3>Projekt #${project.id}</h3>
					<p><strong>Status:</strong> ${project.status || 'Unbekannt'}</p>
					<p><strong>Operator:</strong> ${project.operator || '-'}</p>
					<p><strong>Anzahl Häuser:</strong> ${project.numberOfHomes || 0}</p>
					<p><strong>Preis:</strong> ${project.productPrice ? project.productPrice + '€' : '-'}</p>
				`;
				grid.appendChild(card);
			});
		}

		// ----------- Import Functions -----------
		document.getElementById('importForm').addEventListener('submit', async function(e) {
			e.preventDefault();
			const fileInput = document.getElementById('fileInput');
			const file = fileInput.files[0];
			
			if (!file) {
				document.getElementById('importResult').innerHTML = '<p style="color:red;">Bitte wählen Sie eine Datei aus.</p>';
				return;
			}

			const formData = new FormData();
			formData.append('file', file);

			try {
				const token = sessionStorage.getItem('access_token');
				const headers = token ? { 'Authorization': 'Bearer ' + token } : {};
				
				const res = await fetch('/api/v1/import', {
					method: 'POST',
					headers: headers,
					body: formData
				});

				const result = await res.json();
				
				if (result.success) {
					document.getElementById('importResult').innerHTML = 
						`<p style="color:green;">Import erfolgreich! ${result.recordsProcessed} Datensätze verarbeitet.</p>`;
					loadAllAddresses();
					loadAllNotes();
				} else {
					document.getElementById('importResult').innerHTML = 
						`<p style="color:red;">Import fehlgeschlagen: ${result.errors.join(', ')}</p>`;
				}
			} catch (error) {
				console.error('Import-Fehler:', error);
				document.getElementById('importResult').innerHTML = 
					'<p style="color:red;">Fehler beim Importieren der Datei.</p>';
			}
		});

		// Drag & Drop für Datei-Upload
		const fileInput = document.getElementById('fileInput');
		const fileInputArea = document.querySelector('.file-input');

		fileInputArea.addEventListener('dragover', (e) => {
			e.preventDefault();
			fileInputArea.style.borderColor = '#667eea';
		});

		fileInputArea.addEventListener('dragleave', (e) => {
			e.preventDefault();
			fileInputArea.style.borderColor = '#e9ecef';
		});

		fileInputArea.addEventListener('drop', (e) => {
			e.preventDefault();
			fileInputArea.style.borderColor = '#e9ecef';
			const files = e.dataTransfer.files;
			if (files.length > 0) {
				fileInput.files = files;
				fileInputArea.querySelector('p').textContent = `Datei ausgewählt: ${files[0].name}`;
			}
		});

		fileInput.addEventListener('change', (e) => {
			if (e.target.files.length > 0) {
				fileInputArea.querySelector('p').textContent = `Datei ausgewählt: ${e.target.files[0].name}`;
			}
		});
	</script>
</body>
</html>