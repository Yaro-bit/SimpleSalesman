<!DOCTYPE html>
<html lang="de" data-bs-theme="dark">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Simple Salesman GUI</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
	<style>
		:root {
			--bs-primary: #0066cc;
			--header-height: 80px;
			--footer-height: 60px;
			--sidebar-width: 260px;
		}

		/* Layout */
		body { margin: 0; padding: 0; overflow-x: hidden; }
		
		.app-header {
			position: fixed; top: 0; left: 0; right: 0; height: var(--header-height);
			background: #1a1a1a; border-bottom: 2px solid var(--bs-primary); z-index: 1000;
			display: flex; align-items: center; padding: 0 1rem;
		}
		
		.app-sidebar {
			position: fixed; top: var(--header-height); left: 0; width: var(--sidebar-width);
			height: calc(100vh - var(--header-height) - var(--footer-height));
			background: #2a2a2a; border-right: 2px solid var(--bs-primary); z-index: 900;
			overflow-y: auto; padding: 1rem;
		}
		
		.app-footer {
			position: fixed; bottom: 0; left: 0; right: 0; height: var(--footer-height);
			background: #1a1a1a; border-top: 2px solid var(--bs-primary); z-index: 800;
			display: flex; align-items: center; padding: 0 1rem;
		}
		
		.app-main {
			margin-top: var(--header-height); margin-left: var(--sidebar-width);
			margin-bottom: var(--footer-height); padding: 1rem;
			min-height: calc(100vh - var(--header-height) - var(--footer-height));
			background: #1e1e1e;
		}
		
		/* Components */
		.content-card {
			background: #262626; border: 1px solid #404040; border-radius: 8px; margin-bottom: 1rem;
		}
		.content-card-header {
			padding: 0.75rem 1rem; background: #2d2d2d; border-bottom: 1px solid #404040;
			border-radius: 7px 7px 0 0;
		}
		.content-card-body { padding: 1rem; }
		
		.nav-link {
			color: #a0a0a0; padding: 0.5rem 0.75rem; border-radius: 6px; margin-bottom: 0.25rem;
			display: flex; align-items: center; transition: all 0.2s ease; text-decoration: none;
		}
		.nav-link:hover { background: rgba(0, 102, 204, 0.1); color: #ffffff; }
		.nav-link.active { background: var(--bs-primary); color: #ffffff; }
		
		.table th { border-bottom: 2px solid #404040; cursor: pointer; user-select: none; }
		.table th.sorted-asc::after { content: " ↑"; }
		.table th.sorted-desc::after { content: " ↓"; }
		.table td { border-bottom: 1px solid #404040; }
		
		.app-section { display: none; }
		.app-section.active { display: block; }
		
		.project-tag {
			display: inline-block; background: rgba(0, 102, 204, 0.2); color: var(--bs-primary);
			padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; margin: 2px;
			border: 1px solid var(--bs-primary);
		}
		
		.note-item {
			padding: 8px 0; border-bottom: 1px solid #404040; font-size: 0.9rem; color: #f0f0f0;
		}
		.note-item:last-child { border-bottom: none; }
		.note-meta { font-size: 0.8rem; color: #a0a0a0; margin-top: 4px; }
		
		/* Mobile */
		@media (max-width: 768px) {
			.app-sidebar {
				transform: translateX(-100%); transition: transform 0.3s ease; z-index: 1100;
				top: 0; height: 100vh; padding-top: calc(var(--header-height) + 1rem);
			}
			.app-sidebar.show { transform: translateX(0); }
			.app-main { margin-left: 0; padding: 0.75rem; }
			.content-card-body { padding: 0.75rem; }
		}
		
		.sidebar-overlay {
			display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
			background: rgba(0, 0, 0, 0.5); z-index: 1050;
		}
		.sidebar-overlay.show { display: block; }
		
		/* Utilities */
		::-webkit-scrollbar { width: 6px; }
		::-webkit-scrollbar-track { background: #1a1a1a; }
		::-webkit-scrollbar-thumb { background: var(--bs-primary); border-radius: 3px; }
	</style>
</head>
<body>
	<!-- HEADER -->
	<header class="app-header">
		<div class="d-flex align-items-center w-100">
			<button class="btn btn-outline-light btn-sm d-md-none me-3" onclick="toggleSidebar()">
				<i class="bi bi-list"></i>
			</button>
			<img src="/logo_saleman_original.png" alt="SimpleSalesman" class="me-3 d-block" loading="lazy" style="height:120px;width:auto;max-width:100%;">
			<div class="ms-auto d-flex align-items-center gap-3">
				<span class="text-light">
					<i class="bi bi-person-circle me-1"></i>
					<span id="username" class="d-none d-sm-inline">User</span>
				</span>
				<span class="text-light d-none d-lg-inline d-flex align-items-center">
					<i class="bi bi-cloud-sun-fill me-2 fs-6"></i>
					<span id="weather" class="d-inline-block fw-semibold fs-6">Wetter wird geladen…</span>
				</span>
				<button onclick="logout()" class="btn btn-outline-danger btn-sm">
					<i class="bi bi-box-arrow-right"></i>
					<span class="d-none d-sm-inline ms-1">Abmelden</span>
				</button>
			</div>
		</div>
	</header>

	<!-- SIDEBAR -->
	<nav class="app-sidebar" id="sidebar">
		<div class="mb-3">
			<h6 class="text-light mb-3">Navigation</h6>
			<a href="#" class="nav-link active" onclick="showSection('addresses')" id="nav-addresses">
				<i class="bi bi-geo-alt me-2"></i>Adressen
			</a>
			<a href="#" class="nav-link" onclick="showSection('notes')" id="nav-notes">
				<i class="bi bi-journal-text me-2"></i>Notizen
			</a>
			<a href="#" class="nav-link" onclick="showSection('import')" id="nav-import">
				<i class="bi bi-upload me-2"></i>Import
			</a>
		</div>
	</nav>

	<!-- OVERLAY -->
	<div class="sidebar-overlay" id="overlay" onclick="toggleSidebar()"></div>

	<!-- MAIN CONTENT -->
	<main class="app-main">
		<!-- ADDRESSES SECTION -->
		<div class="app-section active" id="addressesSection">
			<div class="d-flex justify-content-between align-items-center mb-3">
				<h2 class="text-light mb-0">Adressen</h2>
				<div class="btn-group btn-group-sm">
					<button class="btn btn-primary active" onclick="showAddressView('table')" id="view-table">
						<i class="bi bi-table me-1"></i>Tabellenansicht
					</button>
					<button class="btn btn-outline-primary" onclick="showAddressView('navigation')" id="view-navigation">
						<i class="bi bi-map me-1"></i>Navigation
					</button>
				</div>
			</div>

			<!-- TABLE VIEW -->
			<div class="content-card" id="addressesTableBox">
				<div class="content-card-header">
					<h5 class="mb-0 text-light">Alle Adressen</h5>
				</div>
				<div class="content-card-body">
					<div class="row g-2 mb-3">
						<div class="col-md-8">
							<input type="text" class="form-control form-control-sm" id="addressSearchInput"
								placeholder="Suche nach Adresse..." onkeyup="filterTable('addresses')">
						</div>
						<div class="col-md-4">
							<select class="form-select form-select-sm" id="addressPageSize" onchange="changePageSize('addresses')">
								<option value="10">10 pro Seite</option>
								<option value="20" selected>20 pro Seite</option>
								<option value="50">50 pro Seite</option>
							</select>
						</div>
					</div>
					<div class="table-responsive">
						<table class="table table-dark table-sm" id="addressesTable">
							<thead>
								<tr>
									<th onclick="sortTable('addresses', 'plz')">PLZ <i class="bi bi-arrow-down-up"></i></th>
									<th onclick="sortTable('addresses', 'street')">Straße <i class="bi bi-arrow-down-up"></i></th>
									<th onclick="sortTable('addresses', 'number')">Hausnummer <i class="bi bi-arrow-down-up"></i></th>
									<th onclick="sortTable('addresses', 'region')">Region <i class="bi bi-arrow-down-up"></i></th>
									<th>Projekte</th>
									<th>Aktionen</th>
								</tr>
							</thead>
							<tbody>
								<tr>
									<td colspan="6" class="text-center text-muted">
										<div class="spinner-border spinner-border-sm me-2"></div>Adressen werden geladen...
									</td>
								</tr>
							</tbody>
						</table>
					</div>
					<nav id="addressesPagination" class="d-flex justify-content-center mt-3"></nav>
				</div>
			</div>

			<!-- NAVIGATION VIEW -->
			<div class="content-card" id="addressesNavigationBox" style="display:none;">
				<div class="content-card-header">
					<h5 class="mb-0 text-light">Adresse auswählen</h5>
				</div>
				<div class="content-card-body">
					<nav class="mb-3">
						<ol class="breadcrumb bg-dark" id="breadcrumb">
							<li class="breadcrumb-item active">PLZ auswählen</li>
						</ol>
					</nav>
					<button class="btn btn-secondary btn-sm mb-3" id="backButton" onclick="goBack()" style="display:none;">
						<i class="bi bi-arrow-left me-1"></i>Zurück
					</button>
					<div id="plzSelection">
						<h6 class="text-light mb-2">Verfügbare Postleitzahlen:</h6>
						<div id="plzList" class="d-flex flex-wrap gap-2">
							<span class="text-muted">PLZs werden geladen...</span>
						</div>
					</div>
					<div id="streetSelection" style="display:none;">
						<h6 class="text-light mb-2">Straßen:</h6>
						<div id="streetList" class="d-flex flex-wrap gap-2"></div>
					</div>
					<div id="numberSelection" style="display:none;">
						<h6 class="text-light mb-2">Hausnummern:</h6>
						<div id="numberList" class="d-flex flex-wrap gap-2"></div>
					</div>
				</div>
			</div>
		</div>

		<!-- NOTES SECTION -->
		<div class="app-section" id="notesSection">
			<h2 class="text-light mb-3">Notizen</h2>
			<div class="content-card">
				<div class="content-card-header">
					<h5 class="mb-0 text-light">Alle Notizen</h5>
				</div>
				<div class="content-card-body">
					<div class="row g-2 mb-3">
						<div class="col-md-8">
							<input type="text" class="form-control form-control-sm" id="notesSearchInput"
								placeholder="Suche in Notizen..." onkeyup="filterTable('notes')">
						</div>
						<div class="col-md-4">
							<select class="form-select form-select-sm" id="notesPageSize" onchange="changePageSize('notes')">
								<option value="10">10 pro Seite</option>
								<option value="20" selected>20 pro Seite</option>
								<option value="50">50 pro Seite</option>
							</select>
						</div>
					</div>
					<div class="table-responsive">
						<table class="table table-dark table-sm" id="notesTable">
							<thead>
								<tr>
									<th onclick="sortTable('notes', 'id')">ID <i class="bi bi-arrow-down-up"></i></th>
									<th onclick="sortTable('notes', 'address')">Adresse <i class="bi bi-arrow-down-up"></i></th>
									<th onclick="sortTable('notes', 'text')">Notiztext <i class="bi bi-arrow-down-up"></i></th>
									<th onclick="sortTable('notes', 'createdBy')">Erstellt von <i class="bi bi-arrow-down-up"></i></th>
									<th onclick="sortTable('notes', 'createdAt')">Datum <i class="bi bi-arrow-down-up"></i></th>
									<th>Aktionen</th>
								</tr>
							</thead>
							<tbody>
								<tr>
									<td colspan="6" class="text-center text-muted">
										<div class="spinner-border spinner-border-sm me-2"></div>Notizen werden geladen...
									</td>
								</tr>
							</tbody>
						</table>
					</div>
					<nav id="notesPagination" class="d-flex justify-content-center mt-3"></nav>
				</div>
			</div>
		</div>

		<!-- IMPORT SECTION -->
		<div class="app-section" id="importSection">
			<h2 class="text-light mb-3">Import</h2>
			<div class="content-card">
				<div class="content-card-header">
					<h5 class="mb-0 text-light">Excel Import</h5>
				</div>
				<div class="content-card-body">
					<div class="alert alert-warning mb-3">
						<h6 class="alert-heading">
							<i class="bi bi-exclamation-triangle me-2"></i>Wichtige Hinweise für große Dateien
						</h6>
						<ul class="mb-2">
							<li><strong>Große Dateien (>50MB):</strong> Import kann bis zu 3 Stunden dauern</li>
							<li><strong>Mittlere Dateien (20-50MB):</strong> Import dauert 1-2 Stunden</li>
							<li><strong>Kleine Dateien (<20MB):</strong> Import dauert 5-60 Minuten</li>
						</ul>
						<hr>
						<strong>Während des Imports unbedingt beachten:</strong>
						<ul class="mb-0 mt-2">
							<li>✅ Browser-Tab geöffnet lassen</li>
							<li>✅ Computer nicht in Standby versetzen</li>
							<li>✅ Seite nicht neu laden</li>
							<li>❌ Browser nicht schließen</li>
						</ul>
					</div>
					
					<form class="import-form" id="importForm">
						<div class="border border-2 border-dashed border-primary rounded p-4 text-center mb-3 file-input"
							onclick="document.getElementById('fileInput').click()"
							style="cursor:pointer;background:#2a2a2a;transition:all 0.3s ease;">
							<input type="file" id="fileInput" accept=".xlsx,.xls" class="d-none">
							<i class="bi bi-cloud-upload display-6 text-primary mb-2"></i>
							<p class="mb-1 text-light">Klicken Sie hier oder ziehen Sie eine Excel-Datei hierher</p>
							<small class="text-muted">Unterstützte Formate: .xlsx, .xls | Empfohlen: <20MB für schnelleren Import</small>
						</div>
						
						<div class="d-flex gap-2 align-items-center flex-wrap">
							<button type="submit" class="btn btn-primary">
								<i class="bi bi-upload me-1"></i>Datei importieren
							</button>
							<button type="button" class="btn btn-outline-secondary clear-file-btn" 
									onclick="clearSelectedFile()" style="display:none;">
								<i class="bi bi-x-circle me-1"></i>Datei entfernen
							</button>
							<button type="button" class="btn btn-outline-info btn-sm" onclick="requestNotificationPermission()">
								<i class="bi bi-bell me-1"></i>Browser-Benachrichtigungen aktivieren
							</button>
						</div>
						
						<small class="text-muted mt-2 d-block">
							<i class="bi bi-info-circle me-1"></i>
							Tipp: Aktivieren Sie Browser-Benachrichtigungen, um informiert zu werden, wenn der Import abgeschlossen ist.
						</small>
					</form>
					<div id="importResult" class="mt-3"></div>
				</div>
			</div>
		</div>
	</main>

	<!-- FOOTER -->
	<footer class="app-footer">
		<div class="d-flex align-items-center w-100">
			<span class="text-light me-3">SimpleSalesman v0.0.9</span>
			<div class="ms-auto">
				<small class="text-muted">
					<i class="bi bi-check-circle-fill text-success me-1"></i>System Online
				</small>
			</div>
		</div>
	</footer>

	<!-- NOTES MODAL -->
	<div class="modal fade" id="notesModal" tabindex="-1">
		<div class="modal-dialog">
			<div class="modal-content bg-dark">
				<div class="modal-header border-bottom border-secondary">
					<h5 class="modal-title text-light" id="modalTitle">Notizen für Adresse</h5>
					<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
				</div>
				<div class="modal-body">
					<div class="mb-3">
						<h6 class="text-light">Bestehende Notizen:</h6>
						<div id="modalNoteList" class="bg-secondary rounded p-3 mb-3" style="max-height:200px;overflow-y:auto;">
							<p class="text-muted mb-0 loading">Notizen werden geladen...</p>
						</div>
						<div class="mb-3">
							<h6 class="text-light">Zugeordnete Projekte:</h6>
							<div id="modalProjectList" class="bg-secondary rounded p-3 mb-3" style="max-height:150px;overflow-y:auto;">
								<p class="text-muted mb-0 loading">Projekte werden geladen…</p>
							</div>
						</div>
					</div>
					<form class="note-form" id="modalNoteForm">
						<div class="mb-3">
							<label for="modalNewNote" class="form-label text-light">Neue Notiz hinzufügen:</label>
							<textarea class="form-control" id="modalNewNote" rows="3" placeholder="Neue Notiz schreiben..."></textarea>
						</div>
						<button type="submit" class="btn btn-primary">
							<i class="bi bi-save me-1"></i>Notiz speichern
						</button>
					</form>
				</div>
			</div>
		</div>
	</div>

	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

	<script>
		// Global State
		const AppState = {
			addresses: [],
			notes: [],
			selectedAddressId: null,
			currentView: 'table',
			navigation: { step: 'plz', plz: null, street: null, number: null },
			tables: {
				addresses: { page: 1, size: 20, sort: 'plz', order: 'asc', search: '' },
				notes: { page: 1, size: 20, sort: 'id', order: 'desc', search: '' }
			},
			wakeLock: null,
			importInProgress: false
		};

		// Utility Functions
		const Utils = {
			getToken: () => sessionStorage.getItem('access_token'),
			getHeaders: () => {
				const token = Utils.getToken();
				return token ? { 'Authorization': `Bearer ${token}` } : {};
			},
			extractPlz: (addr) => addr.postalCode || addr.plz || Utils.extractFromText(addr.addressText, /\b\d{4,5}\b/),
			extractStreet: (addr) => {
				if (addr.street) return addr.street;
				if (addr.addressText) {
					const match = addr.addressText.match(/^([^,\d]+)/);
					return match ? match[1].trim() : addr.addressText.split(',')[0].trim();
				}
				return '';
			},
			extractNumber: (addr) => addr.houseNumber || Utils.extractFromText(addr.addressText, /\d+[a-zA-Z]*/),
			extractFromText: (text, regex) => {
				if (!text) return '';
				const match = text.match(regex);
				return match ? match[0] : '';
			},
			getAddressString: (addr) => {
				if (!addr) return '-';
				const plz = Utils.extractPlz(addr);
				const street = Utils.extractStreet(addr);
				const number = Utils.extractNumber(addr);
				return `${plz} ${street} ${number}`.trim();
			}
		};

		// API Functions
		const API = {
			async fetchAddresses() {
				const res = await fetch('/api/v1/addresses', { headers: Utils.getHeaders() });
				if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
				return res.json();
			},
			async fetchNotes(addressId) {
				const res = await fetch(`/api/v1/notes/${addressId}`, { headers: Utils.getHeaders() });
				if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
				return res.json();
			},
			async createNote(addressId, text, createdBy) {
				const res = await fetch(`/api/v1/notes/${addressId}`, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json', ...Utils.getHeaders() },
					body: JSON.stringify({ text, createdBy })
				});
				if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
				return res.json();
			},
			async importFile(file) {
				const formData = new FormData();
				formData.append('file', file);
				const res = await fetch('/api/v1/import', {
					method: 'POST',
					headers: Utils.getHeaders(),
					body: formData
				});
				if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
				return res.json();
			},
			async fetchWeather(params) {
				const query = new URLSearchParams(params).toString();
				const res = await fetch(`/api/v1/weather?${query}`, { headers: Utils.getHeaders() });
				if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
				return res.text();
			}
		};

		// Table Management
		const TableManager = {
			render(type) {
				const config = this.getConfig(type);
				const data = this.filterAndSort(type);
				const paginated = this.paginate(data, type);
				
				this.renderTableBody(type, paginated, config);
				this.renderPagination(type, Math.ceil(data.length / AppState.tables[type].size));
				this.updateSortIndicators(type);
			},

			getConfig(type) {
				if (type === 'addresses') {
					return {
						columns: ['plz', 'street', 'number', 'region', 'projects', 'actions'],
						renderRow: (addr) => {
							const projects = (addr.projects || []).map(p => `<span class="project-tag">${p.status || 'Unbekannt'}</span>`).join('');
							return [
								Utils.extractPlz(addr) || '-',
								Utils.extractStreet(addr) || '-',
								Utils.extractNumber(addr) || '-',
								addr.regionName || '-',
								projects || '-',
								`<button onclick="openNotesModal(${addr.id})" class="btn btn-sm btn-primary">
									<i class="bi bi-journal-text me-1"></i>Notizen
								</button>`
							];
						}
					};
				} else {
					return {
						columns: ['id', 'address', 'text', 'createdBy', 'createdAt', 'actions'],
						renderRow: (note) => {
							const addressStr = Utils.getAddressString(note.address);
							const dateStr = note.createdAt ? new Date(note.createdAt).toLocaleString('de-DE') : '-';
							const textPreview = (note.text || '').length > 100 ? (note.text || '').substring(0, 100) + '...' : (note.text || '');
							return [
								note.id || '-',
								addressStr,
								`<span title="${note.text || ''}">${textPreview}</span>`,
								note.createdBy || '-',
								dateStr,
								`<button onclick="openNotesModal(${note.address?.id})" class="btn btn-sm btn-primary">
									<i class="bi bi-eye me-1"></i>Anzeigen
								</button>`
							];
						}
					};
				}
			},

			filterAndSort(type) {
				const state = AppState.tables[type];
				const data = type === 'addresses' ? AppState.addresses : AppState.notes;
				
				// Filter
				let filtered = data.filter(item => {
					if (!state.search) return true;
					const searchString = type === 'addresses' 
						? `${Utils.extractPlz(item)} ${Utils.extractStreet(item)} ${Utils.extractNumber(item)} ${item.regionName || ''}`.toLowerCase()
						: `${item.text || ''} ${item.createdBy || ''} ${Utils.getAddressString(item.address)}`.toLowerCase();
					return searchString.includes(state.search.toLowerCase());
				});

				// Sort
				filtered.sort((a, b) => {
					let aVal, bVal;
					if (type === 'addresses') {
						switch (state.sort) {
							case 'plz': aVal = Utils.extractPlz(a) || ''; bVal = Utils.extractPlz(b) || ''; break;
							case 'street': aVal = Utils.extractStreet(a) || ''; bVal = Utils.extractStreet(b) || ''; break;
							case 'number': aVal = Utils.extractNumber(a) || ''; bVal = Utils.extractNumber(b) || ''; break;
							case 'region': aVal = a.regionName || ''; bVal = b.regionName || ''; break;
							default: aVal = a.addressText || ''; bVal = b.addressText || '';
						}
					} else {
						switch (state.sort) {
							case 'id': aVal = a.id || 0; bVal = b.id || 0; break;
							case 'address': aVal = Utils.getAddressString(a.address); bVal = Utils.getAddressString(b.address); break;
							case 'text': aVal = a.text || ''; bVal = b.text || ''; break;
							case 'createdBy': aVal = a.createdBy || ''; bVal = b.createdBy || ''; break;
							case 'createdAt': aVal = new Date(a.createdAt || 0); bVal = new Date(b.createdAt || 0); break;
							default: aVal = a.id || 0; bVal = b.id || 0;
						}
					}

					if (state.sort === 'createdAt' || state.sort === 'id') {
						return state.order === 'asc' ? aVal - bVal : bVal - aVal;
					} else {
						const comparison = aVal.toString().localeCompare(bVal.toString(), 'de', {numeric: true});
						return state.order === 'asc' ? comparison : -comparison;
					}
				});

				return filtered;
			},

			paginate(data, type) {
				const state = AppState.tables[type];
				const start = (state.page - 1) * state.size;
				return data.slice(start, start + state.size);
			},

			renderTableBody(type, data, config) {
				const tbody = document.querySelector(`#${type}Table tbody`);
				tbody.innerHTML = '';

				if (data.length === 0) {
					tbody.innerHTML = `<tr><td colspan="${config.columns.length}" class="text-center text-muted">Keine ${type === 'addresses' ? 'Adressen' : 'Notizen'} gefunden</td></tr>`;
				} else {
					data.forEach(item => {
						const row = config.renderRow(item);
						tbody.innerHTML += `<tr>${row.map(cell => `<td>${cell}</td>`).join('')}</tr>`;
					});
				}
			},

			renderPagination(type, totalPages) {
				const pagination = document.getElementById(`${type}Pagination`);
				pagination.innerHTML = '';
				if (totalPages <= 1) return;

				const state = AppState.tables[type];
				pagination.className = 'pagination pagination-sm justify-content-center mt-3';

				// Previous
				const prevLi = document.createElement('li');
				prevLi.className = `page-item ${state.page === 1 ? 'disabled' : ''}`;
				prevLi.innerHTML = `<a class="page-link" href="#" onclick="event.preventDefault(); ${state.page > 1 ? `changePage('${type}', ${state.page - 1})` : ''}">‹ Zurück</a>`;
				pagination.appendChild(prevLi);

				// Pages
				const maxVisible = 5;
				let start = Math.max(1, state.page - Math.floor(maxVisible / 2));
				let end = Math.min(totalPages, start + maxVisible - 1);

				for (let page = start; page <= end; page++) {
					const pageLi = document.createElement('li');
					pageLi.className = `page-item ${page === state.page ? 'active' : ''}`;
					pageLi.innerHTML = `<a class="page-link" href="#" onclick="event.preventDefault(); changePage('${type}', ${page})">${page}</a>`;
					pagination.appendChild(pageLi);
				}

				// Next
				const nextLi = document.createElement('li');
				nextLi.className = `page-item ${state.page === totalPages ? 'disabled' : ''}`;
				nextLi.innerHTML = `<a class="page-link" href="#" onclick="event.preventDefault(); ${state.page < totalPages ? `changePage('${type}', ${state.page + 1})` : ''}">Weiter ›</a>`;
				pagination.appendChild(nextLi);
			},

			updateSortIndicators(type) {
				const state = AppState.tables[type];
				document.querySelectorAll(`#${type}Table th`).forEach(th => {
					th.classList.remove('sorted-asc', 'sorted-desc');
				});
				const sortedTh = document.querySelector(`#${type}Table th[onclick*="'${state.sort}'"]`);
				if (sortedTh) sortedTh.classList.add(`sorted-${state.order}`);
			}
		};

		// Data Loading
		async function loadData() {
			try {
				AppState.addresses = await API.fetchAddresses();
				console.log('Loaded addresses:', AppState.addresses.length);
				TableManager.render('addresses');
				showAllPlzs();
				await loadAllNotes();
			} catch (error) {
				console.error('Error loading addresses:', error);
				document.querySelector('#addressesTable tbody').innerHTML = 
					`<tr><td colspan="6" class="text-center text-danger">Fehler: ${error.message}</td></tr>`;
			}
		}

		async function loadAllNotes() {
			if (AppState.addresses.length === 0) return;
			try {
				AppState.notes = [];
				for (const address of AppState.addresses) {
					try {
						const notes = await API.fetchNotes(address.id);
						notes.forEach(note => { note.address = address; });
						AppState.notes.push(...notes);
					} catch (error) {
						console.warn(`Error loading notes for address ${address.id}:`, error);
					}
				}
				console.log('Loaded notes:', AppState.notes.length);
				TableManager.render('notes');
			} catch (error) {
				console.error('Error loading notes:', error);
			}
		}

		// Event Handlers
		function sortTable(type, field) {
			const state = AppState.tables[type];
			if (state.sort === field) {
				state.order = state.order === 'asc' ? 'desc' : 'asc';
			} else {
				state.sort = field;
				state.order = (field === 'createdAt' || field === 'id') ? 'desc' : 'asc';
			}
			state.page = 1;
			TableManager.render(type);
		}

		function filterTable(type) {
			const state = AppState.tables[type];
			state.search = document.getElementById(`${type}SearchInput`).value;
			state.page = 1;
			TableManager.render(type);
		}

		function changePageSize(type) {
			const state = AppState.tables[type];
			state.size = parseInt(document.getElementById(`${type}PageSize`).value);
			state.page = 1;
			TableManager.render(type);
		}

		function changePage(type, page) {
			AppState.tables[type].page = page;
			TableManager.render(type);
		}

		function showSection(sectionName) {
			document.querySelectorAll('.app-section').forEach(s => s.classList.remove('active'));
			document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
			
			document.getElementById(sectionName + 'Section').classList.add('active');
			document.getElementById('nav-' + sectionName).classList.add('active');
			
			const sidebar = document.getElementById('sidebar');
			const overlay = document.getElementById('overlay');
			if (sidebar.classList.contains('show')) {
				sidebar.classList.remove('show');
				overlay.classList.remove('show');
				document.body.style.overflow = '';
			}

			if (sectionName === 'notes' && AppState.notes.length === 0 && AppState.addresses.length > 0) {
				loadAllNotes();
			}
		}

		function showAddressView(view) {
			AppState.currentView = view;
			document.querySelectorAll('#view-table, #view-navigation').forEach(btn => {
				btn.classList.remove('active', 'btn-primary');
				btn.classList.add('btn-outline-primary');
			});
			document.getElementById(`view-${view}`).classList.add('active', 'btn-primary');
			document.getElementById(`view-${view}`).classList.remove('btn-outline-primary');

			document.getElementById('addressesTableBox').style.display = view === 'table' ? 'block' : 'none';
			document.getElementById('addressesNavigationBox').style.display = view === 'navigation' ? 'block' : 'none';
		}

		function toggleSidebar() {
			const sidebar = document.getElementById('sidebar');
			const overlay = document.getElementById('overlay');
			const isShown = sidebar.classList.contains('show');
			
			sidebar.classList.toggle('show', !isShown);
			overlay.classList.toggle('show', !isShown);
			document.body.style.overflow = isShown ? '' : 'hidden';
		}

		// Navigation Functions
		function showAllPlzs() {
			const plzs = [...new Set(AppState.addresses.map(a => Utils.extractPlz(a)).filter(p => p))].sort();
			const el = document.getElementById('plzList');
			el.innerHTML = '';

			if (plzs.length === 0) {
				el.innerHTML = '<p class="text-muted">Keine PLZs verfügbar.</p>';
				return;
			}

			plzs.forEach(plz => {
				const btn = document.createElement('button');
				btn.className = 'btn btn-sm btn-outline-primary';
				btn.textContent = plz;
				btn.onclick = () => selectPlz(plz);
				el.appendChild(btn);
			});
		}

		function selectPlz(plz) {
			AppState.navigation = { step: 'street', plz, street: null, number: null };
			document.getElementById('breadcrumb').innerHTML = `
				<li class="breadcrumb-item">PLZ: ${plz}</li>
				<li class="breadcrumb-item active">Straße auswählen</li>
			`;
			document.getElementById('backButton').style.display = 'block';
			document.getElementById('plzSelection').style.display = 'none';
			document.getElementById('streetSelection').style.display = 'block';
			document.getElementById('numberSelection').style.display = 'none';

			const streets = [...new Set(AppState.addresses
				.filter(a => Utils.extractPlz(a) == plz)
				.map(a => Utils.extractStreet(a))
				.filter(s => s)
			)].sort();

			const el = document.getElementById('streetList');
			el.innerHTML = '';
			streets.forEach(street => {
				const btn = document.createElement('button');
				btn.className = 'btn btn-sm btn-outline-primary';
				btn.textContent = street;
				btn.onclick = () => selectStreet(street);
				el.appendChild(btn);
			});
		}

		function selectStreet(street) {
			AppState.navigation.step = 'number';
			AppState.navigation.street = street;
			document.getElementById('breadcrumb').innerHTML = `
				<li class="breadcrumb-item">PLZ: ${AppState.navigation.plz}</li>
				<li class="breadcrumb-item">Straße: ${street}</li>
				<li class="breadcrumb-item active">Hausnummer auswählen</li>
			`;
			document.getElementById('streetSelection').style.display = 'none';
			document.getElementById('numberSelection').style.display = 'block';

			const numbers = AppState.addresses
				.filter(a => Utils.extractPlz(a) == AppState.navigation.plz && Utils.extractStreet(a) === street)
				.map(a => Utils.extractNumber(a))
				.filter(n => n)
				.sort((a, b) => {
					const numA = parseInt(a), numB = parseInt(b);
					return !isNaN(numA) && !isNaN(numB) ? numA - numB : a.localeCompare(b);
				});

			const el = document.getElementById('numberList');
			el.innerHTML = '';
			numbers.forEach(number => {
				const btn = document.createElement('button');
				btn.className = 'btn btn-sm btn-outline-primary';
				btn.textContent = number;
				btn.onclick = () => selectNumber(number);
				el.appendChild(btn);
			});
		}

		function selectNumber(number) {
			const address = AppState.addresses.find(a => 
				Utils.extractPlz(a) == AppState.navigation.plz && 
				Utils.extractStreet(a) === AppState.navigation.street && 
				Utils.extractNumber(a) === number
			);
			if (address) openNotesModal(address.id);
		}

		function goBack() {
			const nav = AppState.navigation;
			if (nav.step === 'street') {
				nav.step = 'plz';
				nav.plz = null;
				document.getElementById('breadcrumb').innerHTML = '<li class="breadcrumb-item active">PLZ auswählen</li>';
				document.getElementById('backButton').style.display = 'none';
				document.getElementById('plzSelection').style.display = 'block';
				document.getElementById('streetSelection').style.display = 'none';
				document.getElementById('numberSelection').style.display = 'none';
			} else if (nav.step === 'number') {
				nav.step = 'street';
				nav.street = null;
				document.getElementById('breadcrumb').innerHTML = `
					<li class="breadcrumb-item">PLZ: ${nav.plz}</li>
					<li class="breadcrumb-item active">Straße auswählen</li>
				`;
				document.getElementById('streetSelection').style.display = 'block';
				document.getElementById('numberSelection').style.display = 'none';
			}
		}

		// Modal Functions
		function openNotesModal(addressId) {
			AppState.selectedAddressId = addressId;
			const address = AppState.addresses.find(a => a.id === addressId);
			if (address) {
				document.getElementById('modalTitle').textContent = `Notizen für ${Utils.getAddressString(address)}`;
				new bootstrap.Modal(document.getElementById('notesModal')).show();
				loadNotesInModal();
				loadProjectsInModal(address);
			}
		}
		function loadProjectsInModal(address) {
			const el = document.getElementById('modalProjectList');
			el.innerHTML = '<p class="text-muted text-center"><div class="spinner-border spinner-border-sm me-2"></div>Projekte werden geladen…</p>';

			try {
				const projects = address.projects || [];
				if (projects.length === 0) {
					el.innerHTML = '<p class="text-muted text-center"><i class="bi bi-folder-x me-2"></i>Keine Projekte vorhanden.</p>';
					return;
				}

				el.innerHTML = '';
				projects.forEach(project => {
					const id = project.id || '-';
					const status = project.status || '-';
					const operator = project.operator || '-';
					const price = project.productPrice != null ? `${project.productPrice.toFixed(2)} €` : '-';
					const start = project.salesStart ? new Date(project.salesStart).toLocaleDateString('de-DE') : '-';
					const end = project.salesEnd ? new Date(project.salesEnd).toLocaleDateString('de-DE') : '-';
					const homes = project.numberOfHomes || '-';

					const div = document.createElement('div');
					div.className = 'note-item'; // oder eigene CSS-Klasse z.B. 'project-item'
					div.innerHTML = `
						<div class="text-light fw-semibold">Projekt-ID: ${id} | Status: ${status}</div>
						<div class="note-meta">
							Anbieter: ${operator} | Preis: ${price} | Einheiten: ${homes}<br>
							Verkauf: ${start} bis ${end}
						</div>
					`;
					el.appendChild(div);
				});
			} catch (error) {
				console.error('Error loading projects:', error);
				el.innerHTML = `<p class="text-danger text-center"><i class="bi bi-exclamation-triangle me-2"></i>Fehler: ${error.message}</p>`;
			}
		}
		async function loadNotesInModal() {
			const el = document.getElementById('modalNoteList');
			el.innerHTML = '<p class="text-muted text-center"><div class="spinner-border spinner-border-sm me-2"></div>Notizen werden geladen...</p>';
			
			try {
				const notes = await API.fetchNotes(AppState.selectedAddressId);
				el.innerHTML = '';

				if (!notes || notes.length === 0) {
					el.innerHTML = '<p class="text-muted text-center"><i class="bi bi-journal-x me-2"></i>Keine Notizen vorhanden.</p>';
					return;
				}

				notes.forEach(note => {
					const div = document.createElement('div');
					div.className = 'note-item';
					const timeString = note.createdAt ? ' | ' + new Date(note.createdAt).toLocaleString('de-DE') : '';
					div.innerHTML = `
						<div class="text-light">${note.text || 'Notiz ohne Text'}</div>
						<div class="note-meta">Von: ${note.createdBy || 'Unbekannt'}${timeString}</div>
					`;
					el.appendChild(div);
				});
			} catch (error) {
				console.error('Error loading notes:', error);
				el.innerHTML = `<p class="text-danger text-center"><i class="bi bi-exclamation-triangle me-2"></i>Fehler: ${error.message}</p>`;
			}
		}

		// Weather Functions
		async function loadWeather() {
			const weatherElement = document.getElementById('weather');
			weatherElement.textContent = 'Wetter wird geladen...';

			if (navigator.geolocation) {
				navigator.geolocation.getCurrentPosition(async (pos) => {
					try {
						const weather = await API.fetchWeather({ lat: pos.coords.latitude, lon: pos.coords.longitude });
						weatherElement.textContent = weather;
					} catch (error) {
						console.error('Weather error:', error);
						weatherElement.textContent = 'Wetter nicht verfügbar';
					}
				}, () => {
					weatherElement.textContent = 'Standort nicht verfügbar';
				});
			} else {
				weatherElement.textContent = 'Geolocation nicht unterstützt';
			}
		}

		// Import Functions
		function updateFileInputDisplay(file = null) {
			const area = document.querySelector('.file-input');
			const icon = area.querySelector('i');
			const text = area.querySelector('p');
			const subtext = area.querySelector('small');
			const clearBtn = document.querySelector('.clear-file-btn');

			if (file) {
				const sizeInMB = (file.size / (1024 * 1024)).toFixed(2);
				area.style.borderColor = '#28a745';
				area.style.backgroundColor = 'rgba(40, 167, 69, 0.1)';
				icon.className = 'bi bi-file-earmark-check display-6 text-success mb-2';
				text.innerHTML = `<strong>Datei ausgewählt:</strong><br>${file.name}`;
				subtext.textContent = `Größe: ${sizeInMB} MB | Klicken zum Ändern`;
				subtext.className = 'text-success';
				clearBtn.style.display = 'inline-block';
			} else {
				area.style.borderColor = '';
				area.style.backgroundColor = '#2a2a2a';
				icon.className = 'bi bi-cloud-upload display-6 text-primary mb-2';
				text.innerHTML = 'Klicken Sie hier oder ziehen Sie eine Excel-Datei hierher';
				subtext.innerHTML = 'Unterstützte Formate: .xlsx, .xls | Empfohlen: <20MB für schnelleren Import';
				subtext.className = 'text-muted';
				clearBtn.style.display = 'none';
			}
		}

		function clearSelectedFile() {
			document.getElementById('fileInput').value = '';
			updateFileInputDisplay(null);
		}

		function requestNotificationPermission() {
			if (!('Notification' in window)) {
				alert('Ihr Browser unterstützt keine Desktop-Benachrichtigungen.');
				return;
			}

			if (Notification.permission === 'granted') {
				new Notification('SimpleSalesman', {
					body: 'Benachrichtigungen sind bereits aktiviert!',
					icon: '/logo_saleman_original.png'
				});
				return;
			}

			if (Notification.permission !== 'denied') {
				Notification.requestPermission().then(permission => {
					if (permission === 'granted') {
						new Notification('SimpleSalesman', {
							body: 'Benachrichtigungen wurden aktiviert!',
							icon: '/logo_saleman_original.png'
						});
					}
				});
			}
		}

		async function acquireWakeLock() {
			if ('wakeLock' in navigator) {
				try {
					AppState.wakeLock = await navigator.wakeLock.request('screen');
					console.log('Wake lock acquired');
					return true;
				} catch (err) {
					console.warn('Failed to acquire wake lock:', err);
					return false;
				}
			}
			return false;
		}

		function releaseWakeLock() {
			if (AppState.wakeLock) {
				AppState.wakeLock.release();
				AppState.wakeLock = null;
			}
		}

		// Auth Functions
		function logout() {
			if (confirm('Möchten Sie sich wirklich abmelden?')) {
				['access_token', 'username', 'refresh_token', 'user_id'].forEach(key => {
					sessionStorage.removeItem(key);
					localStorage.removeItem(key);
				});
				sessionStorage.setItem('just_logged_out', 'true');
				window.location.href = '/logout';
			}
		}

		// Event Listeners
		document.getElementById('fileInput').addEventListener('change', function() {
			updateFileInputDisplay(this.files[0]);
		});

		document.getElementById('importForm').addEventListener('submit', async function(e) {
			e.preventDefault();
			const file = document.getElementById('fileInput').files[0];
			const submitButton = this.querySelector('button[type="submit"]');
			const importResult = document.getElementById('importResult');

			if (!file) {
				importResult.innerHTML = '<div class="alert alert-danger">Bitte wählen Sie eine Datei aus.</div>';
				return;
			}

			const sizeInMB = file.size / (1024 * 1024);
			let estimatedTime = sizeInMB > 50 ? 'bis zu 3 Stunden' : sizeInMB > 20 ? '1-2 Stunden' : '5-30 Minuten';

			if (!confirm(`Import kann ${estimatedTime} dauern. Browser-Tab offen lassen! Fortfahren?`)) return;

			AppState.importInProgress = true;
			await acquireWakeLock();
			
			submitButton.disabled = true;
			submitButton.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>Import läuft...';
			
			const startTime = Date.now();
			importResult.innerHTML = `
				<div class="alert alert-warning">
					<div class="d-flex align-items-start">
						<div class="spinner-border spinner-border-sm me-3 mt-1"></div>
						<div>
							<h6><i class="bi bi-hourglass-split me-2"></i>Import läuft</h6>
							<p><strong>Datei:</strong> ${file.name} (${sizeInMB.toFixed(1)} MB)<br>
							<strong>Geschätzte Dauer:</strong> ${estimatedTime}</p>
							<div id="importTimer" class="small text-muted">Laufzeit: <span id="timerDisplay">00:00:00</span></div>
						</div>
					</div>
				</div>
			`;

			const timerInterval = setInterval(() => {
				const elapsed = Date.now() - startTime;
				const hours = Math.floor(elapsed / 3600000);
				const minutes = Math.floor((elapsed % 3600000) / 60000);
				const seconds = Math.floor((elapsed % 60000) / 1000);
				const display = document.getElementById('timerDisplay');
				if (display) {
					display.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
				}
			}, 1000);

			try {
				const result = await API.importFile(file);
				clearInterval(timerInterval);
				const totalTime = Date.now() - startTime;
				const totalMinutes = Math.floor(totalTime / 60000);
				const totalSeconds = Math.floor((totalTime % 60000) / 1000);

				if (result.success) {
					importResult.innerHTML = `
						<div class="alert alert-success">
							<h6><i class="bi bi-check-circle me-2"></i>Import erfolgreich!</h6>
							<p><strong>Verarbeitete Datensätze:</strong> ${result.recordsProcessed || 'Unbekannt'}<br>
							<strong>Dauer:</strong> ${totalMinutes}:${totalSeconds.toString().padStart(2, '0')} Minuten</p>
						</div>
					`;
					await loadData();
					if ('Notification' in window && Notification.permission === 'granted') {
						new Notification('SimpleSalesman Import', {
							body: `Import erfolgreich! ${result.recordsProcessed} Datensätze verarbeitet.`,
							icon: '/logo_saleman_original.png'
						});
					}
					setTimeout(() => updateFileInputDisplay(null), 5000);
				} else {
					throw new Error(result.error || 'Import fehlgeschlagen');
				}
			} catch (error) {
				clearInterval(timerInterval);
				console.error('Import error:', error);
				importResult.innerHTML = `
					<div class="alert alert-danger">
						<h6><i class="bi bi-exclamation-triangle me-2"></i>Import-Fehler</h6>
						<p><strong>Fehler:</strong> ${error.message}</p>
					</div>
				`;
			} finally {
				clearInterval(timerInterval);
				AppState.importInProgress = false;
				releaseWakeLock();
				submitButton.disabled = false;
				submitButton.innerHTML = '<i class="bi bi-upload me-1"></i>Datei importieren';
			}
		});

		document.getElementById('modalNoteForm').addEventListener('submit', async function(e) {
			e.preventDefault();
			const text = document.getElementById('modalNewNote').value.trim();
			if (!text || !AppState.selectedAddressId) {
				alert('Bitte geben Sie einen Notiztext ein.');
				return;
			}

			try {
				await API.createNote(AppState.selectedAddressId, text, sessionStorage.getItem('username') || 'Unbekannt');
				document.getElementById('modalNewNote').value = '';
				await loadNotesInModal();
				await loadAllNotes();
				
				const alertDiv = document.createElement('div');
				alertDiv.className = 'alert alert-success alert-dismissible fade show mt-3';
				alertDiv.innerHTML = '<i class="bi bi-check-circle me-2"></i>Notiz erfolgreich gespeichert! <button type="button" class="btn-close" data-bs-dismiss="alert"></button>';
				document.querySelector('.modal-body').insertBefore(alertDiv, document.querySelector('.note-form'));
				setTimeout(() => alertDiv.remove(), 3000);
			} catch (error) {
				console.error('Error saving note:', error);
				const alertDiv = document.createElement('div');
				alertDiv.className = 'alert alert-danger alert-dismissible fade show mt-3';
				alertDiv.innerHTML = `<i class="bi bi-exclamation-triangle me-2"></i>Fehler: ${error.message} <button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
				document.querySelector('.modal-body').insertBefore(alertDiv, document.querySelector('.note-form'));
				setTimeout(() => alertDiv.remove(), 5000);
			}
		});

		// Initialize
		window.addEventListener('load', function() {
			document.getElementById('username').textContent = sessionStorage.getItem('username') || 'User';
			const token = sessionStorage.getItem('access_token');
			if (!token) console.warn('No access token found');
			
			loadData();
			loadWeather();

			if (window.location.search.includes('debug=true')) {
				console.log('=== SimpleSalesman Debug ===');
				console.log('Token:', !!token);
				console.log('Username:', sessionStorage.getItem('username'));
			}
		});
	</script>
</body>
</html>