<!DOCTYPE html>
<html lang="de" data-bs-theme="dark">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>SimpleSalesman</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
	<style>
		:root {
			--primary-color: #6366f1;
			--primary-hover: #5b5df1;
			--surface: #1a1b23;
			--surface-light: #242530;
			--surface-lighter: #2d2f3c;
			--text-primary: #f8fafc;
			--text-secondary: #94a3b8;
			--text-muted: #64748b;
			--border: #334155;
			--border-light: #475569;
			--success: #10b981;
			--warning: #f59e0b;
			--danger: #ef4444;
			--header-height: 70px;
			--sidebar-width: 280px;
			--radius: 12px;
			--shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
		}

		/* Reset & Base */
		* { box-sizing: border-box; }
		body { 
			margin: 0; 
			padding: 0; 
			background: var(--surface); 
			color: var(--text-primary); 
			font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
			overflow-x: hidden;
		}

		/* Layout */
		.app-container {
			display: grid;
			grid-template-columns: var(--sidebar-width) 1fr;
			grid-template-rows: var(--header-height) 1fr;
			height: 100vh;
		}

		.app-header {
			grid-column: 1 / -1;
			background: var(--surface-light);
			border-bottom: 1px solid var(--border);
			display: flex;
			align-items: center;
			padding: 0 2rem;
			z-index: 1000;
		}

		.app-sidebar {
			background: var(--surface-light);
			border-right: 1px solid var(--border);
			padding: 1.5rem;
			overflow-y: auto;
			z-index: 900;
		}

		.app-main {
			background: var(--surface);
			padding: 2rem;
			overflow-y: auto;
		}

		/* Header Components */
		.header-brand {
			display: flex;
			align-items: center;
			gap: 0.75rem;
			font-size: 1.125rem;
			font-weight: 600;
			color: var(--text-primary);
		}

		.header-actions {
			margin-left: auto;
			display: flex;
			align-items: center;
			gap: 1rem;
		}

		.user-info {
			display: flex;
			align-items: center;
			gap: 0.5rem;
			color: var(--text-secondary);
			font-size: 0.875rem;
		}

		.weather-info {
			display: flex;
			align-items: center;
			gap: 0.5rem;
			color: var(--text-secondary);
			font-size: 0.875rem;
			padding: 0.5rem 0.75rem;
			background: var(--surface-lighter);
			border-radius: 6px;
		}

		/* Sidebar Navigation */
		.nav-section {
			margin-bottom: 2rem;
		}

		.nav-title {
			font-size: 0.75rem;
			font-weight: 600;
			text-transform: uppercase;
			letter-spacing: 0.05em;
			color: var(--text-muted);
			margin-bottom: 0.75rem;
		}

		.nav-item {
			display: flex;
			align-items: center;
			gap: 0.75rem;
			padding: 0.75rem;
			border-radius: 8px;
			color: var(--text-secondary);
			text-decoration: none;
			transition: all 0.15s ease;
			margin-bottom: 0.25rem;
			font-size: 0.875rem;
		}

		.nav-item:hover {
			background: var(--surface-lighter);
			color: var(--text-primary);
		}

		.nav-item.active {
			background: var(--primary-color);
			color: white;
		}

		.nav-item i {
			width: 16px;
			text-align: center;
		}

		/* Cards */
		.card {
			background: var(--surface-light);
			border: 1px solid var(--border);
			border-radius: var(--radius);
			box-shadow: var(--shadow);
			overflow: hidden;
		}

		.card-header {
			padding: 1.5rem;
			border-bottom: 1px solid var(--border);
			background: var(--surface-lighter);
		}

		.card-title {
			font-size: 1.125rem;
			font-weight: 600;
			margin: 0;
			color: var(--text-primary);
		}

		.card-body {
			padding: 1.5rem;
		}

		/* Buttons */
		.btn {
			padding: 0.5rem 1rem;
			border-radius: 8px;
			font-weight: 500;
			font-size: 0.875rem;
			border: none;
			cursor: pointer;
			transition: all 0.15s ease;
			text-decoration: none;
			display: inline-flex;
			align-items: center;
			gap: 0.5rem;
		}

		.btn-primary {
			background: var(--primary-color);
			color: white;
		}

		.btn-primary:hover {
			background: var(--primary-hover);
			color: white;
		}

		.btn-secondary {
			background: var(--surface-lighter);
			color: var(--text-secondary);
			border: 1px solid var(--border);
		}

		.btn-secondary:hover {
			background: var(--border);
			color: var(--text-primary);
		}

		.btn-danger {
			background: var(--danger);
			color: white;
		}

		.btn-danger:hover {
			background: #dc2626;
			color: white;
		}

		.btn-sm {
			padding: 0.375rem 0.75rem;
			font-size: 0.8125rem;
		}

		.btn-group {
			display: flex;
			border-radius: 8px;
			overflow: hidden;
		}

		.btn-group .btn {
			border-radius: 0;
			border-right: 1px solid var(--border);
		}

		.btn-group .btn:first-child {
			border-radius: 8px 0 0 8px;
		}

		.btn-group .btn:last-child {
			border-radius: 0 8px 8px 0;
			border-right: none;
		}

		/* Forms */
		.form-control, .form-select {
			background: var(--surface-lighter);
			border: 1px solid var(--border);
			color: var(--text-primary);
			border-radius: 8px;
			padding: 0.5rem 0.75rem;
			font-size: 0.875rem;
			transition: all 0.15s ease;
		}

		.form-control:focus, .form-select:focus {
			outline: none;
			border-color: var(--primary-color);
			box-shadow: 0 0 0 3px rgb(99 102 241 / 0.1);
		}

		/* Tables */
		.table {
			background: transparent;
			color: var(--text-primary);
			font-size: 0.875rem;
		}

		.table th {
			background: var(--surface-lighter);
			border-bottom: 1px solid var(--border);
			color: var(--text-primary);
			font-weight: 600;
			padding: 0.75rem;
			cursor: pointer;
			user-select: none;
			white-space: nowrap;
		}

		.table th:hover {
			background: var(--border);
		}

		.table th.sorted-asc::after { content: " ↑"; color: var(--primary-color); }
		.table th.sorted-desc::after { content: " ↓"; color: var(--primary-color); }

		.table td {
			padding: 0.75rem;
			border-bottom: 1px solid var(--border);
			vertical-align: middle;
		}

		.table tbody tr:hover {
			background: var(--surface-lighter);
		}

		/* Tree Navigation */
		.tree-container {
			background: var(--surface-lighter);
			border-radius: var(--radius);
			padding: 1.5rem;
		}

		.breadcrumb {
			background: var(--surface);
			padding: 0.75rem 1rem;
			border-radius: 8px;
			margin-bottom: 1.5rem;
			border: 1px solid var(--border);
		}

		.breadcrumb-item {
			color: var(--text-secondary);
		}

		.breadcrumb-item.active {
			color: var(--primary-color);
		}

		.breadcrumb-item + .breadcrumb-item::before {
			color: var(--text-muted);
			content: "›";
		}

		.tree-level {
			margin-bottom: 2rem;
		}

		.tree-title {
			font-size: 0.875rem;
			font-weight: 600;
			color: var(--text-secondary);
			margin-bottom: 1rem;
			display: flex;
			align-items: center;
			gap: 0.5rem;
		}

		.tree-grid {
			display: grid;
			grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
			gap: 0.75rem;
		}

		.tree-item {
			background: var(--surface);
			border: 1px solid var(--border);
			border-radius: 8px;
			padding: 0.75rem;
			text-align: center;
			cursor: pointer;
			transition: all 0.15s ease;
			font-size: 0.875rem;
			font-weight: 500;
		}

		.tree-item:hover {
			background: var(--primary-color);
			border-color: var(--primary-color);
			color: white;
		}

		/* Notes */
		.note-item {
			background: var(--surface-lighter);
			border-radius: 8px;
			padding: 1rem;
			margin-bottom: 0.75rem;
			border-left: 3px solid var(--primary-color);
		}

		.note-content {
			color: var(--text-primary);
			line-height: 1.5;
			margin-bottom: 0.5rem;
		}

		.note-meta {
			display: flex;
			justify-content: between;
			align-items: center;
			font-size: 0.75rem;
			color: var(--text-muted);
		}

		.note-actions {
			margin-left: auto;
			display: flex;
			gap: 0.5rem;
		}

		/* Project Tags */
		.project-tag {
			display: inline-block;
			background: var(--primary-color);
			color: white;
			padding: 0.25rem 0.5rem;
			border-radius: 4px;
			font-size: 0.75rem;
			font-weight: 500;
			margin: 0.125rem;
		}

		.project-tag.status-completed { background: var(--success); }
		.project-tag.status-pending { background: var(--warning); }
		.project-tag.status-cancelled { background: var(--danger); }

		/* Pagination */
		.pagination {
			display: flex;
			justify-content: center;
			gap: 0.5rem;
			margin-top: 2rem;
		}

		.page-link {
			background: var(--surface-lighter);
			border: 1px solid var(--border);
			color: var(--text-secondary);
			padding: 0.5rem 0.75rem;
			border-radius: 6px;
			text-decoration: none;
			font-size: 0.875rem;
			transition: all 0.15s ease;
		}

		.page-link:hover {
			background: var(--border);
			color: var(--text-primary);
		}

		.page-item.active .page-link {
			background: var(--primary-color);
			border-color: var(--primary-color);
			color: white;
		}

		/* Import Zone */
		.import-zone {
			border: 2px dashed var(--border);
			border-radius: var(--radius);
			background: var(--surface-lighter);
			padding: 3rem 2rem;
			text-align: center;
			cursor: pointer;
			transition: all 0.15s ease;
		}

		.import-zone:hover, .import-zone.dragover {
			border-color: var(--primary-color);
			background: var(--surface);
		}

		.import-zone.file-selected {
			border-color: var(--success);
			background: rgba(16, 185, 129, 0.1);
		}

		/* Alerts */
		.alert {
			border-radius: var(--radius);
			padding: 1rem;
			margin-bottom: 1rem;
			border: none;
		}

		.alert-success {
			background: rgba(16, 185, 129, 0.1);
			color: var(--success);
			border-left: 3px solid var(--success);
		}

		.alert-warning {
			background: rgba(245, 158, 11, 0.1);
			color: var(--warning);
			border-left: 3px solid var(--warning);
		}

		.alert-danger {
			background: rgba(239, 68, 68, 0.1);
			color: var(--danger);
			border-left: 3px solid var(--danger);
		}

		/* Modal */
		.modal-content {
			background: var(--surface-light);
			border: 1px solid var(--border);
			border-radius: var(--radius);
		}

		.modal-header {
			border-bottom: 1px solid var(--border);
			background: var(--surface-lighter);
		}

		.btn-close {
			filter: invert(1);
		}

		/* Mobile */
		@media (max-width: 768px) {
			.app-container {
				grid-template-columns: 1fr;
				grid-template-rows: var(--header-height) 1fr;
			}

			.app-sidebar {
				position: fixed;
				top: var(--header-height);
				left: 0;
				width: var(--sidebar-width);
				height: calc(100vh - var(--header-height));
				transform: translateX(-100%);
				transition: transform 0.3s ease;
				z-index: 1100;
			}

			.app-sidebar.show {
				transform: translateX(0);
			}

			.app-main {
				padding: 1rem;
			}

			.tree-grid {
				grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
			}

			.header-brand img {
				height: 40px;
			}

			.weather-info {
				display: none;
			}
		}

		/* Utilities */
		.section { display: none; }
		.section.active { display: block; }

		.spinner {
			display: inline-block;
			width: 1rem;
			height: 1rem;
			border: 2px solid var(--border);
			border-top: 2px solid var(--primary-color);
			border-radius: 50%;
			animation: spin 1s linear infinite;
		}

		@keyframes spin {
			0% { transform: rotate(0deg); }
			100% { transform: rotate(360deg); }
		}

		.fade-in {
			animation: fadeIn 0.3s ease;
		}

		@keyframes fadeIn {
			from { opacity: 0; transform: translateY(10px); }
			to { opacity: 1; transform: translateY(0); }
		}

		::-webkit-scrollbar { width: 6px; }
		::-webkit-scrollbar-track { background: var(--surface); }
		::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
		::-webkit-scrollbar-thumb:hover { background: var(--border-light); }
	</style>
</head>
<body>
	<div class="app-container">
		<!-- Header -->
		<header class="app-header">
			<button class="btn btn-secondary d-md-none" onclick="toggleSidebar()">
				<i class="bi bi-list"></i>
			</button>
			
			<div class="header-brand">
				<img src="/logo_saleman_original.png" alt="SimpleSalesman" style="height: 50px; width: auto;">
			</div>

			<div class="header-actions">
				<div class="user-info d-none d-sm-flex">
					<i class="bi bi-person-circle"></i>
					<span id="username">User</span>
				</div>
				
				<div class="weather-info d-none d-lg-flex">
					<i class="bi bi-cloud-sun"></i>
					<span id="weather">Wetter wird geladen…</span>
				</div>
				
				<button class="btn btn-danger btn-sm" onclick="logout()">
					<i class="bi bi-box-arrow-right"></i>
					<span class="d-none d-sm-inline">Abmelden</span>
				</button>
			</div>
		</header>

		<!-- Sidebar -->
		<nav class="app-sidebar" id="sidebar">
			<div class="nav-section">
				<div class="nav-title">Navigation</div>
				<a href="#" class="nav-item active" onclick="showSection('addresses')" id="nav-addresses">
					<i class="bi bi-geo-alt"></i>
					<span>Adressen</span>
				</a>
				<a href="#" class="nav-item" onclick="showSection('notes')" id="nav-notes">
					<i class="bi bi-journal-text"></i>
					<span>Notizen</span>
				</a>
				<a href="#" class="nav-item" onclick="showSection('import')" id="nav-import">
					<i class="bi bi-upload"></i>
					<span>Import</span>
				</a>
			</div>
		</nav>

		<!-- Main Content -->
		<main class="app-main">
			<!-- Addresses Section -->
			<div class="section active" id="addressesSection">
				<div class="d-flex justify-content-between align-items-center mb-4">
					<h1 class="h3 mb-0">Adressen</h1>
					<div class="btn-group">
						<button class="btn btn-primary active" onclick="showAddressView('table')" id="view-table">
							<i class="bi bi-table"></i>
							Tabelle
						</button>
						<button class="btn btn-secondary" onclick="showAddressView('tree')" id="view-tree">
							<i class="bi bi-diagram-3"></i>
							Navigation
						</button>
					</div>
				</div>

				<!-- Table View -->
				<div class="card" id="addressesTableView">
					<div class="card-header">
						<div class="row g-3 align-items-center">
							<div class="col-md-8">
								<input type="text" class="form-control" id="addressSearchInput"
									placeholder="Adressen durchsuchen..." onkeyup="filterTable('addresses')">
							</div>
							<div class="col-md-4">
								<select class="form-select" id="addressPageSize" onchange="changePageSize('addresses')">
									<option value="10">10 pro Seite</option>
									<option value="20" selected>20 pro Seite</option>
									<option value="50">50 pro Seite</option>
								</select>
							</div>
						</div>
					</div>
					<div class="card-body p-0">
						<div class="table-responsive">
							<table class="table table-hover mb-0" id="addressesTable">
								<thead>
									<tr>
										<th onclick="sortTable('addresses', 'plz')">PLZ <i class="bi bi-arrow-down-up"></i></th>
										<th onclick="sortTable('addresses', 'street')">Straße <i class="bi bi-arrow-down-up"></i></th>
										<th onclick="sortTable('addresses', 'number')">Nr. <i class="bi bi-arrow-down-up"></i></th>
										<th onclick="sortTable('addresses', 'region')">Region <i class="bi bi-arrow-down-up"></i></th>
										<th>Projekte</th>
										<th width="120">Aktionen</th>
									</tr>
								</thead>
								<tbody>
									<tr>
										<td colspan="6" class="text-center p-4">
											<div class="spinner me-2"></div>
											Adressen werden geladen...
										</td>
									</tr>
								</tbody>
							</table>
						</div>
						<nav id="addressesPagination"></nav>
					</div>
				</div>

				<!-- Tree View -->
				<div class="card" id="addressesTreeView" style="display: none;">
					<div class="card-body">
						<nav class="breadcrumb" id="breadcrumb">
							<span class="breadcrumb-item active">PLZ auswählen</span>
						</nav>
						
						<button class="btn btn-secondary btn-sm mb-3" id="backButton" onclick="goBack()" style="display: none;">
							<i class="bi bi-arrow-left"></i>
							Zurück
						</button>

						<div class="tree-container">
							<div id="plzSelection" class="tree-level">
								<div class="tree-title">
									<i class="bi bi-hash"></i>
									Verfügbare Postleitzahlen
								</div>
								<div id="plzGrid" class="tree-grid">
									<div class="tree-item">
										<div class="spinner"></div>
									</div>
								</div>
							</div>

							<div id="streetSelection" class="tree-level" style="display: none;">
								<div class="tree-title">
									<i class="bi bi-signpost"></i>
									Straßen auswählen
								</div>
								<div id="streetGrid" class="tree-grid"></div>
							</div>

							<div id="numberSelection" class="tree-level" style="display: none;">
								<div class="tree-title">
									<i class="bi bi-house-door"></i>
									Hausnummern auswählen
								</div>
								<div id="numberGrid" class="tree-grid"></div>
							</div>
						</div>
					</div>
				</div>
			</div>

			<!-- Notes Section -->
			<div class="section" id="notesSection">
				<div class="d-flex justify-content-between align-items-center mb-4">
					<h1 class="h3 mb-0">Notizen</h1>
				</div>

				<div class="card">
					<div class="card-header">
						<div class="row g-3 align-items-center">
							<div class="col-md-8">
								<input type="text" class="form-control" id="notesSearchInput"
									placeholder="Notizen durchsuchen..." onkeyup="filterTable('notes')">
							</div>
							<div class="col-md-4">
								<select class="form-select" id="notesPageSize" onchange="changePageSize('notes')">
									<option value="10">10 pro Seite</option>
									<option value="20" selected>20 pro Seite</option>
									<option value="50">50 pro Seite</option>
								</select>
							</div>
						</div>
					</div>
					<div class="card-body p-0">
						<div class="table-responsive">
							<table class="table table-hover mb-0" id="notesTable">
								<thead>
									<tr>
										<th onclick="sortTable('notes', 'id')">ID <i class="bi bi-arrow-down-up"></i></th>
										<th onclick="sortTable('notes', 'address')">Adresse <i class="bi bi-arrow-down-up"></i></th>
										<th onclick="sortTable('notes', 'text')">Inhalt <i class="bi bi-arrow-down-up"></i></th>
										<th onclick="sortTable('notes', 'createdBy')">Erstellt von <i class="bi bi-arrow-down-up"></i></th>
										<th onclick="sortTable('notes', 'createdAt')">Datum <i class="bi bi-arrow-down-up"></i></th>
										<th width="150">Aktionen</th>
									</tr>
								</thead>
								<tbody>
									<tr>
										<td colspan="6" class="text-center p-4">
											<div class="spinner me-2"></div>
											Notizen werden geladen...
										</td>
									</tr>
								</tbody>
							</table>
						</div>
						<nav id="notesPagination"></nav>
					</div>
				</div>
			</div>

			<!-- Import Section -->
			<div class="section" id="importSection">
				<div class="d-flex justify-content-between align-items-center mb-4">
					<h1 class="h3 mb-0">Import</h1>
				</div>

				<div class="card">
					<div class="card-header">
						<h5 class="card-title">Excel Datei importieren</h5>
					</div>
					<div class="card-body">
						<div class="alert alert-warning">
							<div class="d-flex">
								<i class="bi bi-exclamation-triangle me-2 mt-1"></i>
								<div>
									<strong>Wichtige Hinweise:</strong>
									<ul class="mb-2 mt-2">
										<li>Große Dateien (>50MB): bis zu 3 Stunden</li>
										<li>Mittlere Dateien (20-50MB): 1-2 Stunden</li>
										<li>Kleine Dateien (<20MB): 5-60 Minuten</li>
									</ul>
									<strong>Während des Imports:</strong> Browser-Tab geöffnet lassen, Computer nicht in Standby versetzen
								</div>
							</div>
						</div>

						<form id="importForm">
							<div class="import-zone" onclick="document.getElementById('fileInput').click()">
								<input type="file" id="fileInput" accept=".xlsx,.xls" class="d-none">
								<i class="bi bi-cloud-upload" style="font-size: 3rem; color: var(--primary-color); margin-bottom: 1rem;"></i>
								<h6 class="mb-2">Excel-Datei auswählen</h6>
								<p class="text-muted mb-1">Klicken oder Datei hierher ziehen</p>
								<small class="text-muted">Unterstützte Formate: .xlsx, .xls</small>
							</div>

							<div class="d-flex gap-2 mt-3">
								<button type="submit" class="btn btn-primary">
									<i class="bi bi-upload"></i>
									Import starten
								</button>
								<button type="button" class="btn btn-secondary" onclick="clearSelectedFile()" id="clearFileBtn" style="display: none;">
									<i class="bi bi-x-circle"></i>
									Datei entfernen
								</button>
								<button type="button" class="btn btn-secondary" onclick="requestNotificationPermission()">
									<i class="bi bi-bell"></i>
									Benachrichtigungen aktivieren
								</button>
							</div>
						</form>

						<div id="importResult" class="mt-3"></div>
					</div>
				</div>
			</div>
		</main>
	</div>

	<!-- Notes Modal -->
	<div class="modal fade" id="notesModal" tabindex="-1">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="modalTitle">Notizen</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
				</div>
				<div class="modal-body">
					<!-- Address Info -->
					<div class="mb-4">
						<h6>Adresse</h6>
						<div class="bg-dark p-3 rounded" id="modalAddressInfo">
							<span class="text-muted">Lädt...</span>
						</div>
					</div>

					<!-- Projects -->
					<div class="mb-4">
						<h6>Zugeordnete Projekte</h6>
						<div id="modalProjectList" class="bg-dark p-3 rounded" style="max-height: 150px; overflow-y: auto;">
							<span class="text-muted">Projekte werden geladen...</span>
						</div>
					</div>

					<!-- Existing Notes -->
					<div class="mb-4">
						<h6>Vorhandene Notizen</h6>
						<div id="modalNotesList" style="max-height: 300px; overflow-y: auto;">
							<div class="text-center p-3">
								<div class="spinner me-2"></div>
								Notizen werden geladen...
							</div>
						</div>
					</div>

					<!-- Add New Note -->
					<form id="modalNoteForm">
						<div class="mb-3">
							<label for="modalNewNote" class="form-label">Neue Notiz hinzufügen</label>
							<textarea class="form-control" id="modalNewNote" rows="3" 
								placeholder="Notiz eingeben..."></textarea>
						</div>
						<button type="submit" class="btn btn-primary">
							<i class="bi bi-save"></i>
							Notiz speichern
						</button>
					</form>
				</div>
			</div>
		</div>
	</div>

	<!-- Sidebar Overlay -->
	<div class="position-fixed top-0 start-0 w-100 h-100 d-md-none" 
		 id="sidebarOverlay" 
		 style="background: rgba(0,0,0,0.5); z-index: 1050; display: none;"
		 onclick="toggleSidebar()"></div>

	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
	<script>
		// Global State Management
		const AppState = {
			addresses: [],
			notes: [],
			selectedAddressId: null,
			currentView: 'table',
			navigation: { step: 'plz', plz: null, street: null, number: null },
			tables: {
				addresses: { page: 1, size: 20, sort: 'plz', order: 'asc', search: '' },
				notes: { page: 1, size: 20, sort: 'id', order: 'desc', search: '' }
			},
			wakeLock: null,
			importInProgress: false
		};

		// Utility Functions
		const Utils = {
			getToken: () => sessionStorage.getItem('access_token'),
			getHeaders: () => {
				const token = Utils.getToken();
				return token ? { 'Authorization': `Bearer ${token}` } : {};
			},
			extractPlz: (addr) => addr.postalCode || addr.plz || Utils.extractFromText(addr.addressText, /\b\d{4,5}\b/),
			extractStreet: (addr) => {
				if (addr.street) return addr.street;
				if (addr.addressText) {
					const match = addr.addressText.match(/^([^,\d]+)/);
					return match ? match[1].trim() : addr.addressText.split(',')[0].trim();
				}
				return '';
			},
			extractNumber: (addr) => addr.houseNumber || Utils.extractFromText(addr.addressText, /\d+[a-zA-Z]*/),
			extractFromText: (text, regex) => {
				if (!text) return '';
				const match = text.match(regex);
				return match ? match[0] : '';
			},
			getAddressString: (addr) => {
				if (!addr) return '-';
				const plz = Utils.extractPlz(addr);
				const street = Utils.extractStreet(addr);
				const number = Utils.extractNumber(addr);
				return `${plz} ${street} ${number}`.trim();
			},
			showNotification: (title, body, type = 'info') => {
				if ('Notification' in window && Notification.permission === 'granted') {
					new Notification(title, {
						body,
						icon: '/logo_saleman_original.png'
					});
				}
			}
		};

		// API Functions
		const API = {
			async fetchAddresses() {
				const res = await fetch('/api/v1/addresses', { headers: Utils.getHeaders() });
				if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
				return res.json();
			},
			async fetchNotes(addressId) {
				const res = await fetch(`/api/v1/notes/${addressId}`, { headers: Utils.getHeaders() });
				if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
				return res.json();
			},
			async fetchAllNotes() {
				const res = await fetch('/api/v1/notes', { headers: Utils.getHeaders() });
				if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
				return res.json();
			},
			async createNote(addressId, text, createdBy) {
				const res = await fetch(`/api/v1/notes/${addressId}`, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json', ...Utils.getHeaders() },
					body: JSON.stringify({ text, createdBy })
				});
				if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
				return res.json();
			},
			async deleteNote(noteId) {
				const res = await fetch(`/api/v1/notes/note/${noteId}`, {
					method: 'DELETE',
					headers: Utils.getHeaders()
				});
				if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
				return res.json();
			},
			async importFile(file) {
				const formData = new FormData();
				formData.append('file', file);
				const res = await fetch('/api/v1/import', {
					method: 'POST',
					headers: Utils.getHeaders(),
					body: formData
				});
				if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
				return res.json();
			},
			async fetchWeather(params) {
				const query = new URLSearchParams(params).toString();
				const res = await fetch(`/api/v1/weather?${query}`, { headers: Utils.getHeaders() });
				if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
				return res.text();
			}
		};

		// Table Management
		const TableManager = {
			render(type) {
				const config = this.getConfig(type);
				const data = this.filterAndSort(type);
				const paginated = this.paginate(data, type);
				
				this.renderTableBody(type, paginated, config);
				this.renderPagination(type, Math.ceil(data.length / AppState.tables[type].size));
				this.updateSortIndicators(type);
			},

			getConfig(type) {
				if (type === 'addresses') {
					return {
						columns: ['plz', 'street', 'number', 'region', 'projects', 'actions'],
						renderRow: (addr) => {
							const projects = (addr.projects || []).map(p => {
								const status = p.status || 'unknown';
								const statusClass = status === 'completed' ? 'status-completed' : 
													status === 'pending' ? 'status-pending' : 
													status === 'cancelled' ? 'status-cancelled' : '';
								return `<span class="project-tag ${statusClass}">${status}</span>`;
							}).join('');
							return [
								Utils.extractPlz(addr) || '-',
								Utils.extractStreet(addr) || '-',
								Utils.extractNumber(addr) || '-',
								addr.regionName || '-',
								projects || '-',
								`<button onclick="openNotesModal(${addr.id})" class="btn btn-primary btn-sm">
									<i class="bi bi-journal-text"></i>
								</button>`
							];
						}
					};
				} else {
					return {
						columns: ['id', 'address', 'text', 'createdBy', 'createdAt', 'actions'],
						renderRow: (note) => {
							const addressStr = Utils.getAddressString(note.address);
							const dateStr = note.createdAt ? new Date(note.createdAt).toLocaleString('de-DE') : '-';
							const textPreview = (note.text || '').length > 80 ? (note.text || '').substring(0, 80) + '...' : (note.text || '');
							return [
								note.id || '-',
								addressStr,
								`<span title="${note.text || ''}">${textPreview}</span>`,
								note.createdBy || '-',
								dateStr,
								`<div class="d-flex gap-1">
									<button onclick="openNotesModal(${note.address?.id})" class="btn btn-primary btn-sm">
										<i class="bi bi-eye"></i>
									</button>
									<button onclick="deleteNote(${note.id})" class="btn btn-danger btn-sm">
										<i class="bi bi-trash"></i>
									</button>
								</div>`
							];
						}
					};
				}
			},

			filterAndSort(type) {
				const state = AppState.tables[type];
				const data = type === 'addresses' ? AppState.addresses : AppState.notes;
				
				let filtered = data.filter(item => {
					if (!state.search) return true;
					const searchString = type === 'addresses' 
						? `${Utils.extractPlz(item)} ${Utils.extractStreet(item)} ${Utils.extractNumber(item)} ${item.regionName || ''}`.toLowerCase()
						: `${item.text || ''} ${item.createdBy || ''} ${Utils.getAddressString(item.address)}`.toLowerCase();
					return searchString.includes(state.search.toLowerCase());
				});

				filtered.sort((a, b) => {
					let aVal, bVal;
					if (type === 'addresses') {
						switch (state.sort) {
							case 'plz': aVal = Utils.extractPlz(a) || ''; bVal = Utils.extractPlz(b) || ''; break;
							case 'street': aVal = Utils.extractStreet(a) || ''; bVal = Utils.extractStreet(b) || ''; break;
							case 'number': aVal = Utils.extractNumber(a) || ''; bVal = Utils.extractNumber(b) || ''; break;
							case 'region': aVal = a.regionName || ''; bVal = b.regionName || ''; break;
							default: aVal = a.addressText || ''; bVal = b.addressText || '';
						}
					} else {
						switch (state.sort) {
							case 'id': aVal = a.id || 0; bVal = b.id || 0; break;
							case 'address': aVal = Utils.getAddressString(a.address); bVal = Utils.getAddressString(b.address); break;
							case 'text': aVal = a.text || ''; bVal = b.text || ''; break;
							case 'createdBy': aVal = a.createdBy || ''; bVal = b.createdBy || ''; break;
							case 'createdAt': aVal = new Date(a.createdAt || 0); bVal = new Date(b.createdAt || 0); break;
							default: aVal = a.id || 0; bVal = b.id || 0;
						}
					}

					if (state.sort === 'createdAt' || state.sort === 'id') {
						return state.order === 'asc' ? aVal - bVal : bVal - aVal;
					} else {
						const comparison = aVal.toString().localeCompare(bVal.toString(), 'de', {numeric: true});
						return state.order === 'asc' ? comparison : -comparison;
					}
				});

				return filtered;
			},

			paginate(data, type) {
				const state = AppState.tables[type];
				const start = (state.page - 1) * state.size;
				return data.slice(start, start + state.size);
			},

			renderTableBody(type, data, config) {
				const tbody = document.querySelector(`#${type}Table tbody`);
				tbody.innerHTML = '';

				if (data.length === 0) {
					tbody.innerHTML = `<tr><td colspan="${config.columns.length}" class="text-center p-4 text-muted">Keine ${type === 'addresses' ? 'Adressen' : 'Notizen'} gefunden</td></tr>`;
				} else {
					data.forEach(item => {
						const row = document.createElement('tr');
						row.className = 'fade-in';
						const cells = config.renderRow(item);
						row.innerHTML = cells.map(cell => `<td>${cell}</td>`).join('');
						tbody.appendChild(row);
					});
				}
			},

			renderPagination(type, totalPages) {
				const pagination = document.getElementById(`${type}Pagination`);
				pagination.innerHTML = '';
				if (totalPages <= 1) return;

				const state = AppState.tables[type];
				pagination.className = 'pagination';

				// Previous
				const prevLi = document.createElement('li');
				prevLi.className = `page-item ${state.page === 1 ? 'disabled' : ''}`;
				prevLi.innerHTML = `<a class="page-link" href="#" onclick="event.preventDefault(); ${state.page > 1 ? `changePage('${type}', ${state.page - 1})` : ''}">‹</a>`;
				pagination.appendChild(prevLi);

				// Pages
				const maxVisible = 5;
				let start = Math.max(1, state.page - Math.floor(maxVisible / 2));
				let end = Math.min(totalPages, start + maxVisible - 1);

				for (let page = start; page <= end; page++) {
					const pageLi = document.createElement('li');
					pageLi.className = `page-item ${page === state.page ? 'active' : ''}`;
					pageLi.innerHTML = `<a class="page-link" href="#" onclick="event.preventDefault(); changePage('${type}', ${page})">${page}</a>`;
					pagination.appendChild(pageLi);
				}

				// Next
				const nextLi = document.createElement('li');
				nextLi.className = `page-item ${state.page === totalPages ? 'disabled' : ''}`;
				nextLi.innerHTML = `<a class="page-link" href="#" onclick="event.preventDefault(); ${state.page < totalPages ? `changePage('${type}', ${state.page + 1})` : ''}">›</a>`;
				pagination.appendChild(nextLi);
			},

			updateSortIndicators(type) {
				const state = AppState.tables[type];
				document.querySelectorAll(`#${type}Table th`).forEach(th => {
					th.classList.remove('sorted-asc', 'sorted-desc');
				});
				const sortedTh = document.querySelector(`#${type}Table th[onclick*="'${state.sort}'"]`);
				if (sortedTh) sortedTh.classList.add(`sorted-${state.order}`);
			}
		};

		// Data Loading Functions
		async function loadData() {
			try {
				AppState.addresses = await API.fetchAddresses();
				console.log('Loaded addresses:', AppState.addresses.length);
				TableManager.render('addresses');
				showAllPlzs();
				await loadAllNotes();
			} catch (error) {
				console.error('Error loading addresses:', error);
				document.querySelector('#addressesTable tbody').innerHTML = 
					`<tr><td colspan="6" class="text-center text-danger p-4">Fehler: ${error.message}</td></tr>`;
			}
		}

		async function loadAllNotes() {
			try {
				const notes = await API.fetchAllNotes();
				AppState.notes = notes.map(note => {
					const address = AppState.addresses.find(a => a.id === note.addressId);
					return {
						...note,
						address: address || { id: note.addressId, addressText: note.addressText }
					};
				});
				console.log('Loaded notes:', AppState.notes.length);
				TableManager.render('notes');
			} catch (error) {
				console.error('Error loading notes:', error);
				document.querySelector('#notesTable tbody').innerHTML = 
					`<tr><td colspan="6" class="text-center text-danger p-4">Fehler: ${error.message}</td></tr>`;
			}
		}

		// Event Handlers
		function sortTable(type, field) {
			const state = AppState.tables[type];
			if (state.sort === field) {
				state.order = state.order === 'asc' ? 'desc' : 'asc';
			} else {
				state.sort = field;
				state.order = (field === 'createdAt' || field === 'id') ? 'desc' : 'asc';
			}
			state.page = 1;
			TableManager.render(type);
		}

		function filterTable(type) {
			const state = AppState.tables[type];
			state.search = document.getElementById(`${type}SearchInput`).value;
			state.page = 1;
			TableManager.render(type);
		}

		function changePageSize(type) {
			const state = AppState.tables[type];
			state.size = parseInt(document.getElementById(`${type}PageSize`).value);
			state.page = 1;
			TableManager.render(type);
		}

		function changePage(type, page) {
			AppState.tables[type].page = page;
			TableManager.render(type);
		}

		function showSection(sectionName) {
			document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
			document.querySelectorAll('.nav-item').forEach(l => l.classList.remove('active'));
			
			document.getElementById(sectionName + 'Section').classList.add('active');
			document.getElementById('nav-' + sectionName).classList.add('active');
			
			// Close mobile sidebar
			const sidebar = document.getElementById('sidebar');
			const overlay = document.getElementById('sidebarOverlay');
			if (sidebar.classList.contains('show')) {
				sidebar.classList.remove('show');
				overlay.style.display = 'none';
			}

			if (sectionName === 'notes' && AppState.notes.length === 0 && AppState.addresses.length > 0) {
				loadAllNotes();
			}
		}

		function showAddressView(view) {
			AppState.currentView = view;
			
			// Update button states
			document.getElementById('view-table').className = view === 'table' ? 'btn btn-primary active' : 'btn btn-secondary';
			document.getElementById('view-tree').className = view === 'tree' ? 'btn btn-primary active' : 'btn btn-secondary';

			// Toggle views
			document.getElementById('addressesTableView').style.display = view === 'table' ? 'block' : 'none';
			document.getElementById('addressesTreeView').style.display = view === 'tree' ? 'block' : 'none';
		}

		function toggleSidebar() {
			const sidebar = document.getElementById('sidebar');
			const overlay = document.getElementById('sidebarOverlay');
			const isShown = sidebar.classList.contains('show');
			
			sidebar.classList.toggle('show', !isShown);
			overlay.style.display = isShown ? 'none' : 'block';
		}

		// Tree Navigation Functions
		function showAllPlzs() {
			const plzs = [...new Set(AppState.addresses.map(a => Utils.extractPlz(a)).filter(p => p))].sort();
			const grid = document.getElementById('plzGrid');
			grid.innerHTML = '';

			if (plzs.length === 0) {
				grid.innerHTML = '<div class="tree-item">Keine PLZs verfügbar</div>';
				return;
			}

			plzs.forEach(plz => {
				const item = document.createElement('div');
				item.className = 'tree-item';
				item.textContent = plz;
				item.onclick = () => selectPlz(plz);
				grid.appendChild(item);
			});
		}

		function selectPlz(plz) {
			AppState.navigation = { step: 'street', plz, street: null, number: null };
			
			document.getElementById('breadcrumb').innerHTML = `
				<span class="breadcrumb-item">PLZ: ${plz}</span>
				<span class="breadcrumb-item active">Straße auswählen</span>
			`;
			
			document.getElementById('backButton').style.display = 'block';
			document.getElementById('plzSelection').style.display = 'none';
			document.getElementById('streetSelection').style.display = 'block';
			document.getElementById('numberSelection').style.display = 'none';

			const streets = [...new Set(AppState.addresses
				.filter(a => Utils.extractPlz(a) == plz)
				.map(a => Utils.extractStreet(a))
				.filter(s => s)
			)].sort();

			const grid = document.getElementById('streetGrid');
			grid.innerHTML = '';
			streets.forEach(street => {
				const item = document.createElement('div');
				item.className = 'tree-item';
				item.textContent = street;
				item.onclick = () => selectStreet(street);
				grid.appendChild(item);
			});
		}

		function selectStreet(street) {
			AppState.navigation.step = 'number';
			AppState.navigation.street = street;
			
			document.getElementById('breadcrumb').innerHTML = `
				<span class="breadcrumb-item">PLZ: ${AppState.navigation.plz}</span>
				<span class="breadcrumb-item">Straße: ${street}</span>
				<span class="breadcrumb-item active">Hausnummer auswählen</span>
			`;
			
			document.getElementById('streetSelection').style.display = 'none';
			document.getElementById('numberSelection').style.display = 'block';

			const numbers = AppState.addresses
				.filter(a => Utils.extractPlz(a) == AppState.navigation.plz && Utils.extractStreet(a) === street)
				.map(a => Utils.extractNumber(a))
				.filter(n => n)
				.sort((a, b) => {
					const numA = parseInt(a), numB = parseInt(b);
					return !isNaN(numA) && !isNaN(numB) ? numA - numB : a.localeCompare(b);
				});

			const grid = document.getElementById('numberGrid');
			grid.innerHTML = '';
			numbers.forEach(number => {
				const item = document.createElement('div');
				item.className = 'tree-item';
				item.textContent = number;
				item.onclick = () => selectNumber(number);
				grid.appendChild(item);
			});
		}

		function selectNumber(number) {
			const address = AppState.addresses.find(a => 
				Utils.extractPlz(a) == AppState.navigation.plz && 
				Utils.extractStreet(a) === AppState.navigation.street && 
				Utils.extractNumber(a) === number
			);
			if (address) openNotesModal(address.id);
		}

		function goBack() {
			const nav = AppState.navigation;
			if (nav.step === 'street') {
				nav.step = 'plz';
				nav.plz = null;
				document.getElementById('breadcrumb').innerHTML = '<span class="breadcrumb-item active">PLZ auswählen</span>';
				document.getElementById('backButton').style.display = 'none';
				document.getElementById('plzSelection').style.display = 'block';
				document.getElementById('streetSelection').style.display = 'none';
				document.getElementById('numberSelection').style.display = 'none';
			} else if (nav.step === 'number') {
				nav.step = 'street';
				nav.street = null;
				document.getElementById('breadcrumb').innerHTML = `
					<span class="breadcrumb-item">PLZ: ${nav.plz}</span>
					<span class="breadcrumb-item active">Straße auswählen</span>
				`;
				document.getElementById('streetSelection').style.display = 'block';
				document.getElementById('numberSelection').style.display = 'none';
			}
		}

		// Modal Functions
		function openNotesModal(addressId) {
			AppState.selectedAddressId = addressId;
			const address = AppState.addresses.find(a => a.id === addressId);
			if (address) {
				document.getElementById('modalTitle').textContent = `Notizen - ${Utils.getAddressString(address)}`;
				document.getElementById('modalAddressInfo').innerHTML = `
					<div class="d-flex justify-content-between align-items-center">
						<span>${Utils.getAddressString(address)}</span>
						<small class="text-muted">ID: ${address.id}</small>
					</div>
				`;
				new bootstrap.Modal(document.getElementById('notesModal')).show();
				loadNotesInModal();
				loadProjectsInModal(address);
			}
		}

		function loadProjectsInModal(address) {
			const el = document.getElementById('modalProjectList');
			el.innerHTML = '<div class="text-center"><div class="spinner me-2"></div>Projekte werden geladen…</div>';

			try {
				const projects = address.projects || [];
				if (projects.length === 0) {
					el.innerHTML = '<div class="text-center text-muted"><i class="bi bi-folder-x me-2"></i>Keine Projekte vorhanden.</div>';
					return;
				}

				el.innerHTML = '';
				projects.forEach((project, index) => {
					const id = project.id || '-';
					const status = project.status || '-';
					const operator = project.operator || '-';
					const price = project.productPrice != null ? `${project.productPrice.toFixed(2)} €` : '-';
					const start = project.salesStart ? new Date(project.salesStart).toLocaleDateString('de-DE') : '-';
					const end = project.salesEnd ? new Date(project.salesEnd).toLocaleDateString('de-DE') : '-';
					const homes = project.numberOfHomes || '-';

					const statusClass = status === 'completed' ? 'status-completed' : 
										status === 'pending' ? 'status-pending' : 
										status === 'cancelled' ? 'status-cancelled' : '';

					const div = document.createElement('div');
					div.className = 'note-item fade-in';
					div.innerHTML = `
						<div class="d-flex justify-content-between align-items-start">
							<div>
								<div class="d-flex align-items-center gap-2 mb-1">
									<strong>Projekt ${id}</strong>
									<span class="project-tag ${statusClass}">${status}</span>
								</div>
								<div class="text-muted small">
									<div>Anbieter: ${operator} | Preis: ${price}</div>
									<div>Einheiten: ${homes} | Laufzeit: ${start} - ${end}</div>
								</div>
							</div>
						</div>
					`;
					el.appendChild(div);
				});
			} catch (error) {
				console.error('Error loading projects:', error);
				el.innerHTML = `<div class="text-center text-danger"><i class="bi bi-exclamation-triangle me-2"></i>Fehler: ${error.message}</div>`;
			}
		}

		async function loadNotesInModal() {
			const el = document.getElementById('modalNotesList');
			el.innerHTML = '<div class="text-center p-3"><div class="spinner me-2"></div>Notizen werden geladen...</div>';
			
			try {
				const notes = await API.fetchNotes(AppState.selectedAddressId);
				el.innerHTML = '';

				if (!notes || notes.length === 0) {
					el.innerHTML = '<div class="text-center text-muted p-3"><i class="bi bi-journal-x me-2"></i>Keine Notizen vorhanden.</div>';
					return;
				}

				notes.forEach(note => {
					const div = document.createElement('div');
					div.className = 'note-item fade-in';
					const timeString = note.createdAt ? new Date(note.createdAt).toLocaleString('de-DE') : 'Unbekannt';
					div.innerHTML = `
						<div class="note-content">${note.text || 'Notiz ohne Text'}</div>
						<div class="note-meta">
							<span>Von: ${note.createdBy || 'Unbekannt'} | ${timeString}</span>
							<div class="note-actions">
								<button onclick="deleteNote(${note.id})" class="btn btn-danger btn-sm">
									<i class="bi bi-trash"></i>
								</button>
							</div>
						</div>
					`;
					el.appendChild(div);
				});
			} catch (error) {
				console.error('Error loading notes:', error);
				el.innerHTML = `<div class="text-center text-danger p-3"><i class="bi bi-exclamation-triangle me-2"></i>Fehler: ${error.message}</div>`;
			}
		}

		// Note Management
		async function deleteNote(noteId) {
			if (!confirm('Möchten Sie diese Notiz wirklich löschen?')) return;

			try {
				await API.deleteNote(noteId);
				
				// Remove from local state
				AppState.notes = AppState.notes.filter(n => n.id !== noteId);
				
				// Refresh displays
				TableManager.render('notes');
				if (AppState.selectedAddressId) {
					loadNotesInModal();
				}

				Utils.showNotification('SimpleSalesman', 'Notiz erfolgreich gelöscht');
			} catch (error) {
				console.error('Error deleting note:', error);
				alert(`Fehler beim Löschen der Notiz: ${error.message}`);
			}
		}

		// Weather Functions
		async function loadWeather() {
			const weatherElement = document.getElementById('weather');
			weatherElement.textContent = 'Wetter wird geladen...';

			if (navigator.geolocation) {
				navigator.geolocation.getCurrentPosition(async (pos) => {
					try {
						const weather = await API.fetchWeather({ lat: pos.coords.latitude, lon: pos.coords.longitude });
						weatherElement.textContent = weather;
					} catch (error) {
						console.error('Weather error:', error);
						weatherElement.textContent = 'Wetter nicht verfügbar';
					}
				}, () => {
					weatherElement.textContent = 'Standort nicht verfügbar';
				});
			} else {
				weatherElement.textContent = 'Geolocation nicht unterstützt';
			}
		}

		// Import Functions
		function updateFileInputDisplay(file = null) {
			const zone = document.querySelector('.import-zone');
			const clearBtn = document.getElementById('clearFileBtn');

			if (file) {
				const sizeInMB = (file.size / (1024 * 1024)).toFixed(2);
				zone.classList.add('file-selected');
				zone.innerHTML = `
					<i class="bi bi-file-earmark-check" style="font-size: 3rem; color: var(--success); margin-bottom: 1rem;"></i>
					<h6 class="mb-2 text-success">Datei ausgewählt</h6>
					<p class="mb-1"><strong>${file.name}</strong></p>
					<small class="text-muted">Größe: ${sizeInMB} MB | Klicken zum Ändern</small>
				`;
				clearBtn.style.display = 'inline-flex';
			} else {
				zone.classList.remove('file-selected');
				zone.innerHTML = `
					<i class="bi bi-cloud-upload" style="font-size: 3rem; color: var(--primary-color); margin-bottom: 1rem;"></i>
					<h6 class="mb-2">Excel-Datei auswählen</h6>
					<p class="text-muted mb-1">Klicken oder Datei hierher ziehen</p>
					<small class="text-muted">Unterstützte Formate: .xlsx, .xls</small>
				`;
				clearBtn.style.display = 'none';
			}
		}

		function clearSelectedFile() {
			document.getElementById('fileInput').value = '';
			updateFileInputDisplay(null);
		}

		function requestNotificationPermission() {
			if (!('Notification' in window)) {
				alert('Ihr Browser unterstützt keine Desktop-Benachrichtigungen.');
				return;
			}

			if (Notification.permission === 'granted') {
				Utils.showNotification('SimpleSalesman', 'Benachrichtigungen sind bereits aktiviert!');
				return;
			}

			if (Notification.permission !== 'denied') {
				Notification.requestPermission().then(permission => {
					if (permission === 'granted') {
						Utils.showNotification('SimpleSalesman', 'Benachrichtigungen wurden aktiviert!');
					}
				});
			}
		}

		async function acquireWakeLock() {
			if ('wakeLock' in navigator) {
				try {
					AppState.wakeLock = await navigator.wakeLock.request('screen');
					console.log('Wake lock acquired');
					return true;
				} catch (err) {
					console.warn('Failed to acquire wake lock:', err);
					return false;
				}
			}
			return false;
		}

		function releaseWakeLock() {
			if (AppState.wakeLock) {
				AppState.wakeLock.release();
				AppState.wakeLock = null;
			}
		}

		// Auth Functions
		function logout() {
			if (confirm('Möchten Sie sich wirklich abmelden?')) {
				['access_token', 'username', 'refresh_token', 'user_id'].forEach(key => {
					sessionStorage.removeItem(key);
					localStorage.removeItem(key);
				});
				sessionStorage.setItem('just_logged_out', 'true');
				window.location.href = '/logout';
			}
		}

		// Event Listeners
		document.getElementById('fileInput').addEventListener('change', function() {
			updateFileInputDisplay(this.files[0]);
		});

		// Drag and drop for file input
		const importZone = document.querySelector('.import-zone');
		
		importZone.addEventListener('dragover', (e) => {
			e.preventDefault();
			importZone.classList.add('dragover');
		});

		importZone.addEventListener('dragleave', (e) => {
			e.preventDefault();
			importZone.classList.remove('dragover');
		});

		importZone.addEventListener('drop', (e) => {
			e.preventDefault();
			importZone.classList.remove('dragover');
			const files = e.dataTransfer.files;
			if (files.length > 0 && (files[0].name.endsWith('.xlsx') || files[0].name.endsWith('.xls'))) {
				document.getElementById('fileInput').files = files;
				updateFileInputDisplay(files[0]);
			}
		});

		document.getElementById('importForm').addEventListener('submit', async function(e) {
			e.preventDefault();
			const file = document.getElementById('fileInput').files[0];
			const submitButton = this.querySelector('button[type="submit"]');
			const importResult = document.getElementById('importResult');

			if (!file) {
				importResult.innerHTML = '<div class="alert alert-danger">Bitte wählen Sie eine Datei aus.</div>';
				return;
			}

			const sizeInMB = file.size / (1024 * 1024);
			let estimatedTime = sizeInMB > 50 ? 'bis zu 3 Stunden' : sizeInMB > 20 ? '1-2 Stunden' : '5-30 Minuten';

			if (!confirm(`Import kann ${estimatedTime} dauern. Browser-Tab offen lassen! Fortfahren?`)) return;

			AppState.importInProgress = true;
			await acquireWakeLock();
			
			submitButton.disabled = true;
			submitButton.innerHTML = '<div class="spinner me-2"></div>Import läuft...';
			
			const startTime = Date.now();
			importResult.innerHTML = `
				<div class="alert alert-warning">
					<div class="d-flex align-items-start">
						<div class="spinner me-3 mt-1"></div>
						<div class="flex-grow-1">
							<h6><i class="bi bi-hourglass-split me-2"></i>Import läuft</h6>
							<div class="mb-2">
								<strong>Datei:</strong> ${file.name} (${sizeInMB.toFixed(1)} MB)<br>
								<strong>Geschätzte Dauer:</strong> ${estimatedTime}
							</div>
							<div class="small">Laufzeit: <span id="timerDisplay">00:00:00</span></div>
						</div>
					</div>
				</div>
			`;

			const timerInterval = setInterval(() => {
				const elapsed = Date.now() - startTime;
				const hours = Math.floor(elapsed / 3600000);
				const minutes = Math.floor((elapsed % 3600000) / 60000);
				const seconds = Math.floor((elapsed % 60000) / 1000);
				const display = document.getElementById('timerDisplay');
				if (display) {
					display.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
				}
			}, 1000);

			try {
				const result = await API.importFile(file);
				clearInterval(timerInterval);
				const totalTime = Date.now() - startTime;
				const totalMinutes = Math.floor(totalTime / 60000);
				const totalSeconds = Math.floor((totalTime % 60000) / 1000);

				if (result.success) {
					importResult.innerHTML = `
						<div class="alert alert-success">
							<h6><i class="bi bi-check-circle me-2"></i>Import erfolgreich!</h6>
							<div>
								<strong>Verarbeitete Datensätze:</strong> ${result.recordsProcessed || 'Unbekannt'}<br>
								<strong>Dauer:</strong> ${totalMinutes}:${totalSeconds.toString().padStart(2, '0')} Minuten
							</div>
						</div>
					`;
					await loadData();
					Utils.showNotification('SimpleSalesman Import', `Import erfolgreich! ${result.recordsProcessed} Datensätze verarbeitet.`);
					setTimeout(() => updateFileInputDisplay(null), 5000);
				} else {
					throw new Error(result.error || 'Import fehlgeschlagen');
				}
			} catch (error) {
				clearInterval(timerInterval);
				console.error('Import error:', error);
				importResult.innerHTML = `
					<div class="alert alert-danger">
						<h6><i class="bi bi-exclamation-triangle me-2"></i>Import-Fehler</h6>
						<div><strong>Fehler:</strong> ${error.message}</div>
					</div>
				`;
			} finally {
				clearInterval(timerInterval);
				AppState.importInProgress = false;
				releaseWakeLock();
				submitButton.disabled = false;
				submitButton.innerHTML = '<i class="bi bi-upload"></i>Import starten';
			}
		});

		document.getElementById('modalNoteForm').addEventListener('submit', async function(e) {
			e.preventDefault();
			const text = document.getElementById('modalNewNote').value.trim();
			if (!text || !AppState.selectedAddressId) {
				alert('Bitte geben Sie einen Notiztext ein.');
				return;
			}

			try {
				await API.createNote(AppState.selectedAddressId, text, sessionStorage.getItem('username') || 'Unbekannt');
				document.getElementById('modalNewNote').value = '';
				await loadNotesInModal();
				await loadAllNotes();
				
				const alertDiv = document.createElement('div');
				alertDiv.className = 'alert alert-success mt-3';
				alertDiv.innerHTML = '<i class="bi bi-check-circle me-2"></i>Notiz erfolgreich gespeichert!';
				document.querySelector('.modal-body').insertBefore(alertDiv, document.querySelector('#modalNoteForm'));
				setTimeout(() => alertDiv.remove(), 3000);
			} catch (error) {
				console.error('Error saving note:', error);
				const alertDiv = document.createElement('div');
				alertDiv.className = 'alert alert-danger mt-3';
				alertDiv.innerHTML = `<i class="bi bi-exclamation-triangle me-2"></i>Fehler: ${error.message}`;
				document.querySelector('.modal-body').insertBefore(alertDiv, document.querySelector('#modalNoteForm'));
				setTimeout(() => alertDiv.remove(), 5000);
			}
		});

		// Initialize Application
		window.addEventListener('load', function() {
			document.getElementById('username').textContent = sessionStorage.getItem('username') || 'User';
			const token = sessionStorage.getItem('access_token');
			if (!token) console.warn('No access token found');
			
			loadData();
			loadWeather();

			if (window.location.search.includes('debug=true')) {
				console.log('=== SimpleSalesman Debug ===');
				console.log('Token:', !!token);
				console.log('Username:', sessionStorage.getItem('username'));
			}
		});
	</script>
</body>
</html>